<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>tomcat. server.xml加载 | Essay</title>
  <meta name="author" content="shanhm1991">
  
  <meta name="description" content="引言前文介绍过，Tomcat的容器结构通过server.xml来描述，那么看一下它在启动时是如何解析和加载的。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="tomcat. server.xml加载"/>
  <meta property="og:site_name" content="Essay"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Essay" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-147251181-1', 'auto');
	ga('send', 'pageview');

</script>


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header id="header" class="inner"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="alignleft">
  <h1><a href="/">Essay</a></h1>
  <h2><font style="color: #999;">articles:  68 &nbsp;&nbsp;&nbsp; views: <span id="busuanzi_value_site_uv"></span></font></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/about">Abount</a></li>
    
      <li><a href="/books">Books</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>

<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-20171103" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2017-11-02T16:00:00.000Z"><a href="/2017/11/03/20171103/">2017-11-03</a></time>
      
      

  
  
    <h1 class="p-name title" itemprop="headline name">
        tomcat. server.xml加载
    </h1>
    
    
  
  
  


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


   <font style="color: #999;"> words: 5.2k  &nbsp;&nbsp; views: <span id="busuanzi_value_page_pv"></span> &nbsp;&nbsp; time: 26min</font>
   
   
  
  <div class="categories">
    <a href="/categories/源码笔记/">源码笔记</a>
  </div>


   
   
  
  <div class="tags">
    <a href="/tags/tomcat/">tomcat</a>
  </div>


   
   <hr style="background-color: #ddd; height:1px; border:none;" /><br>
   


    </header>
      
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>前文介绍过，Tomcat的容器结构通过<code>server.xml</code>来描述，那么看一下它在启动时是如何解析和加载的。</p>
<a id="more"></a>

<h3 id="1-Digester"><a href="#1-Digester" class="headerlink" title="1. Digester"></a>1. Digester</h3><p>在介绍<code>server.xml</code>的解析实现之前，先看一下解析时使用的工具<code>Digester</code>。</p>
<p>一般解析xml文件有两种思路：</p>
<ol>
<li>预加载DOM树</li>
</ol>
<p>即将整个xml读取到内存中，并构造一个DOM树，也叫对象模型集合，然后只需要操作这个树就可以了。
对于DOM解析有两个实现：jdom和dom4j解析，两者思路差不多，只不过一个是官方出的，一个是社区出的，通常用dom4j比较多。</p>
<ol start="2">
<li>事件机制SAX</li>
</ol>
<p>即一行一行的读取xml，每遇到一个节点，就产生对应的事件，在事件中可以获取节点属性进行处理。</p>
<p>DOM的好处是xml的结构在内存中很清晰，能够维护元素与元素之间的关系，但是代价是内存消耗大。SAX不会在内存中保存解析数据，
所以不怎么消耗内存，但同时也就不能保存元素之间的关系了。当解析下一个元素时，上一个元素的信息就丢弃了，
因此在使用SAX进行解析时，每当遇到一个节点，要么立即处理要么丢弃。对于比较简单和固定的xml，可以使用if-else来处理，
比如之前利用SAX实现过一个Excel的解析：<a href="https://shanhm1991.github.io/2019/06/29/20190629/">poi解析. 二. 利用SAX降低内存消耗</a><br>但是，当xml比较复杂而且要求解析时要求保持元素直接的嵌套关系的话，就需要一种更结构化的设计了。
<font color="#E51508">Digester的思路是提前配置好各节点的处理规则及顺序，然后在解析时，每当遇到一个节点，
就从规则容器中获取它对应的规则，并进行处理，这样让解析过程更加灵活。</font></p>
<h4 id="1-1-Digester结构"><a href="#1-1-Digester结构" class="headerlink" title="1.1. Digester结构"></a>1.1. Digester结构</h4><p><img src="/img/20171105.1.jpg" alt=""></p>
<p>Digester的大体结构如上面类图所示，就是维护了一些解析规则<code>Rule</code>，然后在具体xml解析时进行match和处理。</p>
<h4 id="1-2-Digester实现"><a href="#1-2-Digester实现" class="headerlink" title="1.2. Digester实现"></a>1.2. Digester实现</h4><p>Digester对外提供<code>parse</code>解析接口，并将具体的解析操作委托给<code>XMLReader</code>，同时将<code>XMLReader</code>中的各种<code>Handler</code>处理设置成自己，
然后在具体解析过程中回调自己的实现。<code>XMLReader</code>相当于定义了一套解析步骤，而Digester封装了它的访问并提供了具体的步骤实现。</p>
<p>因此，在看Digester的具体步骤实现之前，首先得清楚<font color="#E51508">sax中DefaultHandler解析xml的步骤：
开始和结束分别是startDocument和endDocument，对于每个节点则是startElement-characters-endElement</font></p>
<figure class="highlight java"><figcaption><span class="caption">org.apache.tomcat.util.digester.Digester</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Digester</span> <span class="keyword">extends</span> <span class="title">DefaultHandler2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> SAXParser parser = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> XMLReader reader = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">protected</span> Rules rules = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> StringBuilder bodyText = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ArrayStack&lt;StringBuilder&gt; bodyTexts = <span class="keyword">new</span> ArrayStack&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String match = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ArrayStack&lt;List&lt;Rule&gt;&gt; matches = <span class="keyword">new</span> ArrayStack&lt;&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ArrayStack&lt;Object&gt; stack = <span class="keyword">new</span> ArrayStack&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">parse</span><span class="params">(InputSource input)</span> <span class="keyword">throws</span> IOException, SAXException </span>&#123;</span><br><span class="line">        configure();</span><br><span class="line marked">        getXMLReader().parse(input);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> XMLReader <span class="title">getXMLReader</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            reader = getParser().getXMLReader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        reader.setDTDHandler(<span class="keyword">this</span>);</span><br><span class="line marked">        reader.setContentHandler(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (entityResolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">            reader.setEntityResolver(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reader.setEntityResolver(entityResolver);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        reader.setProperty(<span class="string">"http://xml.org/sax/properties/lexical-handler"</span>, <span class="keyword">this</span>);</span><br><span class="line">        reader.setErrorHandler(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SAXParser <span class="title">getParser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Return the parser we already created (if any)</span></span><br><span class="line">        <span class="keyword">if</span> (parser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> parser;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a new parser</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parser = getFactory().newSAXParser();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"Digester.getParser: "</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> parser;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-2-1-startDocument"><a href="#1-2-1-startDocument" class="headerlink" title="1.2.1. startDocument"></a>1.2.1. startDocument</h5><p>比较简单，只是将字符集和日志进行了初始化。</p>
<h5 id="1-2-2-startElement"><a href="#1-2-2-startElement" class="headerlink" title="1.2.2. startElement"></a>1.2.2. startElement</h5><p>主要调用对应规则Rule的<code>begin</code>事件，一般是创建实例并初始化属性，然后压入栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String namespaceURI, String localName, String qName, Attributes list)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean</span> debug = log.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</span><br><span class="line">		saxLog.debug(<span class="string">"startElement("</span> + namespaceURI + <span class="string">","</span> + localName + <span class="string">","</span> + qName + <span class="string">")"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 替换attributes值中的系统变量，比如$&#123;xxx&#125;</span></span><br><span class="line">	<span class="comment">// Parse system properties </span></span><br><span class="line">	list = updateAttributes(list);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Save the body text accumulated for our surrounding element</span></span><br><span class="line">	bodyTexts.push(bodyText);</span><br><span class="line">	bodyText = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// name优先取值localName，如果就取qName</span></span><br><span class="line">	<span class="comment">// the actual element name is either in localName or qName, depending</span></span><br><span class="line">	<span class="comment">// on whether the parser is namespace aware</span></span><br><span class="line">	String name = localName;</span><br><span class="line">	<span class="keyword">if</span> ((name == <span class="keyword">null</span>) || (name.length() &lt; <span class="number">1</span>)) &#123;</span><br><span class="line">		name = qName;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 如果match已经有值xx，说明是嵌套节点，那么用/将match拼接成xx/name</span></span><br><span class="line">	<span class="comment">// Compute the current matching rule</span></span><br><span class="line">	StringBuilder sb = <span class="keyword">new</span> StringBuilder(match);</span><br><span class="line">	<span class="keyword">if</span> (match.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		sb.append(<span class="string">'/'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	sb.append(name);</span><br><span class="line">	match = sb.toString();</span><br><span class="line">	<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">		log.debug(<span class="string">"  New match='"</span> + match + <span class="string">"'"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 根据namespaceURI, match匹配处理规则，并压入规则栈，以便在对应的endElement中直接获取</span></span><br><span class="line">	<span class="comment">// Fire "begin" events for all relevant rules</span></span><br><span class="line marked">	List&lt;Rule&gt; rules = getRules().match(namespaceURI, match);</span><br><span class="line marked">	matches.push(rules);</span><br><span class="line">	<span class="keyword">if</span> ((rules != <span class="keyword">null</span>) &amp;&amp; (rules.size() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Rule rule = rules.get(i);</span><br><span class="line">				<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">					log.debug(<span class="string">"  Fire begin() for "</span> + rule);</span><br><span class="line">				&#125;</span><br><span class="line marked">				rule.begin(namespaceURI, name, list);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				log.error(<span class="string">"Begin event threw exception"</span>, e);</span><br><span class="line">				<span class="keyword">throw</span> createSAXException(e);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Error e) &#123;</span><br><span class="line">				log.error(<span class="string">"Begin event threw error"</span>, e);</span><br><span class="line">				<span class="keyword">throw</span> e;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">			log.debug(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-2-3-characters"><a href="#1-2-3-characters" class="headerlink" title="1.2.3. characters"></a>1.2.3. characters</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">characters</span><span class="params">(<span class="keyword">char</span> buffer[], <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</span><br><span class="line">		saxLog.debug(<span class="string">"characters("</span> + <span class="keyword">new</span> String(buffer, start, length) + <span class="string">")"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	bodyText.append(buffer, start, length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-2-4-endElement"><a href="#1-2-4-endElement" class="headerlink" title="1.2.4. endElement"></a>1.2.4. endElement</h5><p>对应的，主要调用对应规则Rule的<code>end</code>事件，一般是从栈中按序弹出对象，并赋值它们的依赖关系。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String namespaceURI, String localName, String qName)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean</span> debug = log.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">		<span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</span><br><span class="line">			saxLog.debug(<span class="string">"endElement("</span> + namespaceURI + <span class="string">","</span> + localName + <span class="string">","</span> + qName + <span class="string">")"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		log.debug(<span class="string">"  match='"</span> + match + <span class="string">"'"</span>);</span><br><span class="line">		log.debug(<span class="string">"  bodyText='"</span> + bodyText + <span class="string">"'"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 替换当前节点文本值中的系统变量，比如$&#123;xxx&#125;</span></span><br><span class="line">	<span class="comment">// Parse system properties</span></span><br><span class="line">	bodyText = updateBodyText(bodyText);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// name优先取值localName，如果就取qName</span></span><br><span class="line">	<span class="comment">// the actual element name is either in localName or qName, depending</span></span><br><span class="line">	<span class="comment">// on whether the parser is namespace aware</span></span><br><span class="line">	String name = localName;</span><br><span class="line">	<span class="keyword">if</span> ((name == <span class="keyword">null</span>) || (name.length() &lt; <span class="number">1</span>)) &#123;</span><br><span class="line">		name = qName;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 获取当前节点的处理规则进行处理</span></span><br><span class="line">	<span class="comment">// Fire "body" events for all relevant rules</span></span><br><span class="line">	List&lt;Rule&gt; rules = matches.pop();</span><br><span class="line">	<span class="keyword">if</span> ((rules != <span class="keyword">null</span>) &amp;&amp; (rules.size() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">		String bodyText = <span class="keyword">this</span>.bodyText.toString();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Rule rule = rules.get(i);</span><br><span class="line">				<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">					log.debug(<span class="string">"  Fire body() for "</span> + rule);</span><br><span class="line">				&#125;</span><br><span class="line">				rule.body(namespaceURI, name, bodyText);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				log.error(<span class="string">"Body event threw exception"</span>, e);</span><br><span class="line">				<span class="keyword">throw</span> createSAXException(e);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Error e) &#123;</span><br><span class="line">				log.error(<span class="string">"Body event threw error"</span>, e);</span><br><span class="line">				<span class="keyword">throw</span> e;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">			log.debug(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (rulesValidation) &#123;</span><br><span class="line">			log.warn(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 结束当前节点时，将bodyText恢复成父节点的值，以便父节点紧接着进入endElement时能看到自己的值</span></span><br><span class="line">	<span class="comment">// Recover the body text from the surrounding element</span></span><br><span class="line">	bodyText = bodyTexts.pop();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 以相反的顺序触发所有相关规则的结束事件，对应SetNextRule.end的实现，组织对象的依赖关系</span></span><br><span class="line">	<span class="comment">// Fire "end" events for all relevant rules in reverse order</span></span><br><span class="line">	<span class="keyword">if</span> (rules != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</span><br><span class="line">			<span class="keyword">int</span> j = (rules.size() - i) - <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Rule rule = rules.get(j);</span><br><span class="line">				<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">					log.debug(<span class="string">"  Fire end() for "</span> + rule);</span><br><span class="line">				&#125;</span><br><span class="line">				rule.end(namespaceURI, name);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				log.error(<span class="string">"End event threw exception"</span>, e);</span><br><span class="line">				<span class="keyword">throw</span> createSAXException(e);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Error e) &#123;</span><br><span class="line">				log.error(<span class="string">"End event threw error"</span>, e);</span><br><span class="line">				<span class="keyword">throw</span> e;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 与startElement中相对于，如果match包含/，说明当前是嵌套节点，那么将自己从match中擦去便可</span></span><br><span class="line">	<span class="comment">// Recover the previous match expression</span></span><br><span class="line">	<span class="keyword">int</span> slash = match.lastIndexOf(<span class="string">'/'</span>);</span><br><span class="line">	<span class="keyword">if</span> (slash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		match = match.substring(<span class="number">0</span>, slash);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		match = <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-2-5-endDocument"><a href="#1-2-5-endDocument" class="headerlink" title="1.2.5. endDocument"></a>1.2.5. endDocument</h5><p>也比较简单，即调用所有Rule的<code>finish</code>时间。</p>
<h3 id="3-Rule实现"><a href="#3-Rule实现" class="headerlink" title="3. Rule实现"></a>3. Rule实现</h3><p>所有的Rule都有一个对应的key，保存在Digester中，这样当解析节点时就可以通过key匹配到对应的规则。其实匹配到的是一组规则，
并且是有序的，可以从其存储结构上看出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> HashMap&lt;String,List&lt;Rule&gt;&gt; cache = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>另外，从上面Digester实现看出，Rule中定了几个接口分别对应了解析过程的几个步骤，比如<code>startElement</code>对应<code>begin</code>，
<code>endElement</code>对应<code>end</code>等，下面来看几个具体的Rule实现</p>
<h4 id="3-1-ObjectCreateRule"><a href="#3-1-ObjectCreateRule" class="headerlink" title="3.1. ObjectCreateRule"></a>3.1. ObjectCreateRule</h4><p><code>begin</code>：加载给定的class（如果attributes中有配置，那么覆盖），加载后实例化一个对象并压入<code>digester</code>的对象栈<code>stack</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String name, Attributes attributes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="comment">// Identify the name of the class to instantiate</span></span><br><span class="line">	String realClassName = className;</span><br><span class="line">	<span class="keyword">if</span> (attributeName != <span class="keyword">null</span>) &#123;</span><br><span class="line">		String value = attributes.getValue(attributeName);</span><br><span class="line">		<span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">			realClassName = value;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</span><br><span class="line">		digester.log.debug(<span class="string">"[ObjectCreateRule]&#123;"</span> + digester.match + <span class="string">"&#125;New "</span> + realClassName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (realClassName == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"No class name specified for "</span> + namespace + <span class="string">" "</span> + name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Instantiate the new object and push it on the context stack</span></span><br><span class="line marked">	Class&lt;?&gt; clazz = digester.getClassLoader().loadClass(realClassName);</span><br><span class="line marked">	Object instance = clazz.getConstructor().newInstance();</span><br><span class="line marked">	digester.push(instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>end</code>：弹出栈顶对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">(String namespace, String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line marked">    Object top = digester.pop();</span><br><span class="line">    <span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</span><br><span class="line">        digester.log.debug(<span class="string">"[ObjectCreateRule]&#123;"</span> + digester.match + <span class="string">"&#125; Pop "</span> + top.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-SetPropertiesRule"><a href="#3-2-SetPropertiesRule" class="headerlink" title="3.2. SetPropertiesRule"></a>3.2. SetPropertiesRule</h4><p><code>begin</code>：获取<code>digester</code>的栈顶对象，并用attributes中的配置给对象的属性赋值。注意这里是<code>peek</code>而不是<code>pop</code>，只是获取而并没有弹出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String theName, Attributes attributes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="comment">// Populate the corresponding properties of the top object</span></span><br><span class="line marked">	Object top = digester.peek();</span><br><span class="line">	<span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</span><br><span class="line">			digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</span><br><span class="line">					<span class="string">"&#125; Set "</span> + top.getClass().getName() + <span class="string">" properties"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match + <span class="string">"&#125; Set NULL properties"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</span><br><span class="line">		String name = attributes.getLocalName(i);</span><br><span class="line">		<span class="keyword">if</span> (<span class="string">""</span>.equals(name)) &#123;</span><br><span class="line">			name = attributes.getQName(i);</span><br><span class="line">		&#125;</span><br><span class="line">		String value = attributes.getValue(i);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</span><br><span class="line">			digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</span><br><span class="line">					<span class="string">"&#125; Setting property '"</span> + name + <span class="string">"' to '"</span> + value + <span class="string">"'"</span>);</span><br><span class="line">		&#125;</span><br><span class="line marked">		<span class="keyword">if</span> (!digester.isFakeAttribute(top, name) &amp;&amp; !IntrospectionUtils.setProperty(top, name, value)</span><br><span class="line">				&amp;&amp; digester.getRulesValidation()) &#123;</span><br><span class="line">			digester.log.warn(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</span><br><span class="line">					<span class="string">"&#125; Setting property '"</span> + name + <span class="string">"' to '"</span> +</span><br><span class="line">					value + <span class="string">"' did not find a matching property."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-SetNextRule"><a href="#3-3-SetNextRule" class="headerlink" title="3.3. SetNextRule"></a>3.3. SetNextRule</h4><p><code>end</code>：获取<code>digester</code>的栈顶对象<code>child</code>和它下面一个对象<code>parent</code>，并设置它们的依赖关系。这里<code>peek(n)</code>
是指获取相对栈顶位置为n的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">(String namespace, String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="comment">// Identify the objects to be used</span></span><br><span class="line">	Object child = digester.peek(<span class="number">0</span>);</span><br><span class="line">	Object parent = digester.peek(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">			digester.log.debug(<span class="string">"[SetNextRule]&#123;"</span> + digester.match +</span><br><span class="line">				<span class="string">"&#125; Call [NULL PARENT]."</span> + methodName + <span class="string">"("</span> + child + <span class="string">")"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			digester.log.debug(<span class="string">"[SetNextRule]&#123;"</span> + digester.match +</span><br><span class="line">				<span class="string">"&#125; Call "</span> + parent.getClass().getName() + <span class="string">"."</span> + methodName + <span class="string">"("</span> + child + <span class="string">")"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Call the specified method</span></span><br><span class="line">	IntrospectionUtils.callMethod1(parent, methodName, child, paramType, digester.getClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-server-xml加载"><a href="#4-server-xml加载" class="headerlink" title="4. server.xml加载"></a>4. server.xml加载</h3><p><code>server.xml</code>的具体解析是在<code>Catalina.load</code>过程中进行的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> String configFile = <span class="string">"conf/server.xml"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建Digester并初始化解析规则</span></span><br><span class="line">	Digester digester = createStartDigester();</span><br><span class="line"></span><br><span class="line">	InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line">	InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">	File file = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			file = configFile();</span><br><span class="line">			inputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">			inputSource = <span class="keyword">new</span> InputSource(file.toURI().toURL().toString());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">				log.debug(sm.getString(<span class="string">"catalina.configFail"</span>, file), e);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				inputStream = getClass().getClassLoader()</span><br><span class="line">						.getResourceAsStream(getConfigFile());</span><br><span class="line">				inputSource = <span class="keyword">new</span> InputSource</span><br><span class="line">						(getClass().getClassLoader()</span><br><span class="line">								.getResource(getConfigFile()).toString());</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">					log.debug(sm.getString(<span class="string">"catalina.configFail"</span>,</span><br><span class="line">							getConfigFile()), e);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// This should be included in catalina.jar</span></span><br><span class="line">		<span class="comment">// Alternative: don't bother with xml, just create it manually.</span></span><br><span class="line">		<span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				inputStream = getClass().getClassLoader()</span><br><span class="line">						.getResourceAsStream(<span class="string">"server-embed.xml"</span>);</span><br><span class="line">				inputSource = <span class="keyword">new</span> InputSource</span><br><span class="line">						(getClass().getClassLoader()</span><br><span class="line">								.getResource(<span class="string">"server-embed.xml"</span>).toString());</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">					log.debug(sm.getString(<span class="string">"catalina.configFail"</span>,</span><br><span class="line">							<span class="string">"server-embed.xml"</span>), e);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (inputStream == <span class="keyword">null</span> || inputSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>  (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">				log.warn(sm.getString(<span class="string">"catalina.configFail"</span>,</span><br><span class="line">						getConfigFile() + <span class="string">"] or [server-embed.xml]"</span>));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				log.warn(sm.getString(<span class="string">"catalina.configFail"</span>,</span><br><span class="line">						file.getAbsolutePath()));</span><br><span class="line">				<span class="keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</span><br><span class="line">					log.warn(<span class="string">"Permissions incorrect, read permission is not allowed on the file."</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 用inputStream构造一个sax的inputSource</span></span><br><span class="line">			inputSource.setByteStream(inputStream);</span><br><span class="line">			<span class="comment">// 把Catalina压入digester的栈顶</span></span><br><span class="line">			digester.push(<span class="keyword">this</span>);</span><br><span class="line">			<span class="comment">// 使用配置好的Rule解析server.xml</span></span><br><span class="line">			digester.parse(inputSource);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SAXParseException spe) &#123;</span><br><span class="line">			log.warn(<span class="string">"Catalina.start using "</span> + getConfigFile() + <span class="string">": "</span> +</span><br><span class="line">					spe.getMessage());</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.warn(<span class="string">"Catalina.start using "</span> + getConfigFile() + <span class="string">": "</span> , e);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				inputStream.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="comment">// Ignore</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面看一下Digester中解析规则的设置，其实它就设置了server.xml的加载过程  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Digester <span class="title">createStartDigester</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">long</span> t1=System.currentTimeMillis();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Initialize the digester</span></span><br><span class="line">	Digester digester = <span class="keyword">new</span> Digester();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 是否对xml文档进行类似XSD等类型的校验，默认为fasle。</span></span><br><span class="line">	digester.setValidating(<span class="keyword">false</span>); </span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 是否进行节点设置规则校验，如果xml中相应节点没有设置解析规则会在控制台显示提示信息。</span></span><br><span class="line">	digester.setRulesValidation(<span class="keyword">true</span>); </span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 在调用setter方法的时候，将XML节点中的一些属性忽略</span></span><br><span class="line">	Map&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Ignore className on all elements</span></span><br><span class="line">	List&lt;String&gt; objectAttrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	objectAttrs.add(<span class="string">"className"</span>);</span><br><span class="line">	fakeAttributes.put(Object<span class="class">.<span class="keyword">class</span>, <span class="title">objectAttrs</span>)</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Ignore attribute added by Eclipse for its internal tracking</span></span><br><span class="line">	List&lt;String&gt; contextAttrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	contextAttrs.add(<span class="string">"source"</span>);</span><br><span class="line">	fakeAttributes.put(StandardContext<span class="class">.<span class="keyword">class</span>, <span class="title">contextAttrs</span>)</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Ignore Connector attribute used internally but set on Server</span></span><br><span class="line">	List&lt;String&gt; connectorAttrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	connectorAttrs.add(<span class="string">"portOffset"</span>);</span><br><span class="line">	fakeAttributes.put(Connector<span class="class">.<span class="keyword">class</span>, <span class="title">connectorAttrs</span>)</span>;</span><br><span class="line">	digester.setFakeAttributes(fakeAttributes);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 使用上下文加载器，实际上就是catalinaLoader</span></span><br><span class="line">	digester.setUseContextClassLoader(<span class="keyword">true</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 下面即具体设置解析规则，具体如下:</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><ol>
<li>首先创建Server，并在最后赋值给Catalina（Catalina在栈底，Server其次，后面是依次创建的组件）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server"</span>,<span class="string">"org.apache.catalina.core.StandardServer"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server"</span>,<span class="string">"setServer"</span>,<span class="string">"org.apache.catalina.Server"</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>为Server添加全局J2EE企业命名上下文</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server/GlobalNamingResources"</span>,<span class="string">"org.apache.catalina.deploy.NamingResourcesImpl"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/GlobalNamingResources"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/GlobalNamingResources"</span>,</span><br><span class="line">                      <span class="string">"setGlobalNamingResources"</span>,<span class="string">"org.apache.catalina.deploy.NamingResourcesImpl"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Server-Listener"><a href="#Server-Listener" class="headerlink" title="Server/Listener"></a>Server/Listener</h4><ol start="3">
<li>为Server添加生命周期监听器(className在server.xml中配置)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server/Listener"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Listener"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Listener"</span>,<span class="string">"addLifecycleListener"</span>,<span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br></pre></td></tr></table></figure>

<p>一共添加了5个监听器，servei.xml中配置如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Security listener. Documentation at /docs/config/listeners.html</span></span><br><span class="line"><span class="comment">&lt;Listener className="org.apache.catalina.security.SecurityListener" /&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--APR library loader. Documentation at /docs/apr.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>VersionLoggerListener</code>: 在Server初始化之前打印操作系统，JVM以及服务器的版本信息。</li>
<li><code>AprLifecycleListener</code>: 在Server初始化之前加载APR库，并于Server停止之后销毁。</li>
<li><code>JreMemoryLeakPreventionListener</code>: 在Server初始化之前调用，以解决单例对象创建导致的JVM内存泄漏问题以及锁文件问题。</li>
<li><code>GlobalResourcesLifecycleListener</code>: 在Server启动时，将JNDI资源注册为MBean进行管理。</li>
<li><code>ThreadLocalLeakPreventionListener</code>: 用于在Context停止时重建Exceutor池中的线程，避免导致内存泄漏。</li>
</ul>
<h4 id="Server-Service"><a href="#Server-Service" class="headerlink" title="Server/Service"></a>Server/Service</h4><ol start="4">
<li>给Server添加Service实例</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server/Service"</span>,<span class="string">"org.apache.catalina.core.StandardService"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Service"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service"</span>,<span class="string">"addService"</span>,<span class="string">"org.apache.catalina.Service"</span>);</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>给Service添加生命周期监听器，servei.xml中默认没有</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server/Service/Listener"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Service/Listener"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Listener"</span>,<span class="string">"addLifecycleListener"</span>,<span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Server-Service-Executor"><a href="#Server-Service-Executor" class="headerlink" title="Server/Service/Executor"></a>Server/Service/Executor</h4><ol start="6">
<li>为Service添加Executor</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server/Service/Executor"</span>,<span class="string">"org.apache.catalina.core.StandardThreadExecutor"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Service/Executor"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Executor"</span>,<span class="string">"addExecutor"</span>,<span class="string">"org.apache.catalina.Executor"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Server-Service-Connector"><a href="#Server-Service-Connector" class="headerlink" title="Server/Service/Connector"></a>Server/Service/Connector</h4><ol start="7">
<li>为Service添加Connector</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">digester.addRule(<span class="string">"Server/Service/Connector"</span>,<span class="keyword">new</span> ConnectorCreateRule());</span><br><span class="line">digester.addRule(<span class="string">"Server/Service/Connector"</span>,</span><br><span class="line">                  <span class="keyword">new</span> SetAllPropertiesRule(<span class="keyword">new</span> String[]&#123;<span class="string">"executor"</span>, <span class="string">"sslImplementationName"</span>, <span class="string">"protocol"</span>&#125;));</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Connector"</span>,<span class="string">"addConnector"</span>,<span class="string">"org.apache.catalina.connector.Connector"</span>);</span><br><span class="line">digester.addRule(<span class="string">"Server/Service/Connector"</span>, <span class="keyword">new</span> AddPortOffsetRule());</span><br></pre></td></tr></table></figure>

<p>设置相关属性时，将<code>executor</code>和<code>sslImplementationName</code>属性排除，因为在<code>Connector</code>创建时，
会判断当前是否指定了<code>executor</code>属性，
如果是，则从<code>Service</code>中查找该名称的<code>executor</code>并设置到<code>Connector</code>中。同样，<code>Connector</code>创建时，
也会判断是否添加了<code>sslIlplementationName</code>属性，如果是，则将属性值设置到使用的协议中，为其指定一个SSL实现。</p>
<ol start="8">
<li><p>Connector添加虚拟主机SSL配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server/Service/Connector/SSLHostConfig"</span>,</span><br><span class="line">		<span class="string">"org.apache.tomcat.util.net.SSLHostConfig"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Service/Connector/SSLHostConfig"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Connector/SSLHostConfig"</span>,</span><br><span class="line">		<span class="string">"addSslHostConfig"</span>,<span class="string">"org.apache.tomcat.util.net.SSLHostConfig"</span>);	</span><br><span class="line"></span><br><span class="line">digester.addRule(<span class="string">"Server/Service/Connector/SSLHostConfig/Certificate"</span>,</span><br><span class="line">		<span class="keyword">new</span> CertificateCreateRule());</span><br><span class="line">digester.addRule(<span class="string">"Server/Service/Connector/SSLHostConfig/Certificate"</span>,</span><br><span class="line">		<span class="keyword">new</span> SetAllPropertiesRule(<span class="keyword">new</span> String[]&#123;<span class="string">"type"</span>&#125;));</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Connector/SSLHostConfig/Certificate"</span>,</span><br><span class="line">		<span class="string">"addCertificate"</span>,<span class="string">"org.apache.tomcat.util.net.SSLHostConfigCertificate"</span>);</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(<span class="string">"Server/Service/Connector/SSLHostConfig/OpenSSLConf"</span>,</span><br><span class="line">		<span class="string">"org.apache.tomcat.util.net.openssl.OpenSSLConf"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Service/Connector/SSLHostConfig/OpenSSLConf"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Connector/SSLHostConfig/OpenSSLConf"</span>,</span><br><span class="line">		<span class="string">"setOpenSslConf"</span>,<span class="string">"org.apache.tomcat.util.net.openssl.OpenSSLConf"</span>);</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(<span class="string">"Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd"</span>,</span><br><span class="line">		<span class="string">"org.apache.tomcat.util.net.openssl.OpenSSLConfCmd"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd"</span>,</span><br><span class="line">		<span class="string">"addCmd"</span>,<span class="string">"org.apache.tomcat.util.net.openssl.OpenSSLConfCmd"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>为Connector添加生命周期监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server/Service/Connector/Listener"</span>,<span class="keyword">null</span>, <span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Service/Connector/Listener"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Connector/Listener"</span>,</span><br><span class="line">		<span class="string">"addLifecycleListener"</span>,<span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>为Connector添加升级协议，用于支持HTTP/2，8.5新增</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">"Server/Service/Connector/UpgradeProtocol"</span>,<span class="keyword">null</span>, <span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">"Server/Service/Connector/UpgradeProtocol"</span>);</span><br><span class="line">digester.addSetNext(<span class="string">"Server/Service/Connector/UpgradeProtocol"</span>,</span><br><span class="line">		<span class="string">"addUpgradeProtocol"</span>,<span class="string">"org.apache.coyote.UpgradeProtocol"</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="Server-Service-Engine"><a href="#Server-Service-Engine" class="headerlink" title="Server/Service/Engine"></a>Server/Service/Engine</h4><ol start="11">
<li>添加子元素解析规则<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Add RuleSets for nested elements</span></span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/GlobalNamingResources/"</span>));</span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> EngineRuleSet(<span class="string">"Server/Service/"</span>));</span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> HostRuleSet(<span class="string">"Server/Service/Engine/"</span>));</span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> ContextRuleSet(<span class="string">"Server/Service/Engine/Host/"</span>));</span><br><span class="line">addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Host/Cluster/"</span>);</span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/Service/Engine/Host/Context/"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// When the 'engine' is found, set the parentClassLoader.</span></span><br><span class="line">digester.addRule(<span class="string">"Server/Service/Engine"</span>,<span class="keyword">new</span> SetParentClassLoaderRule(parentClassLoader));</span><br><span class="line">addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Cluster/"</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>ruleset相当于对一群相关的Rule作了一个打包，下面看几个比较关心的组件加载</p>
<p>11.1. Engine的解析</p>
<p>即<code>digester.addRuleSet(new EngineRuleSet(&quot;Server/Service/&quot;));</code>实际上，它添加了如下规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Engine实例并设置属性，添加一个默认的生命周期监听器，最后添加到Service中(prefix = "Server/Service/")</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Engine"</span>,<span class="string">"org.apache.catalina.core.StandardEngine"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Engine"</span>);</span><br><span class="line">digester.addRule(prefix + <span class="string">"Engine"</span>,</span><br><span class="line">                 <span class="keyword">new</span> LifecycleListenerRule(<span class="string">"org.apache.catalina.startup.EngineConfig"</span>,<span class="string">"engineConfigClass"</span>));</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Engine"</span>,<span class="string">"setContainer"</span>,<span class="string">"org.apache.catalina.Engine"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Engine添加集群配置</span></span><br><span class="line"><span class="comment">// Cluster configuration start</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Engine/Cluster"</span>,<span class="keyword">null</span>, <span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Engine/Cluster"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Engine/Cluster"</span>,<span class="string">"setCluster"</span>,<span class="string">"org.apache.catalina.Cluster"</span>);</span><br><span class="line"><span class="comment">// Cluster configuration end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Engine添加生命周期监听器</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Engine/Listener"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Engine/Listener"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Engine/Listener"</span>,<span class="string">"addLifecycleListener"</span>,<span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line"></span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> RealmRuleSet(prefix + <span class="string">"Engine/"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Engine添加安全配置</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Engine/Valve"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Engine/Valve"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Engine/Valve"</span>,<span class="string">"addValve"</span>,<span class="string">"org.apache.catalina.Valve"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Server-Service-Engine-Host"><a href="#Server-Service-Engine-Host" class="headerlink" title="Server/Service/Engine/Host"></a>Server/Service/Engine/Host</h4><p>11.2. Host的解析</p>
<p>即<code>digester.addRuleSet(new HostRuleSet(&quot;Server/Service/Engine/&quot;));</code>实际上，它添加了如下规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Host实例并设置属性，添加一个默认的生命周期监听器，最后添加到Engine中(prefix = "Server/Service/Engine/")</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Host"</span>,<span class="string">"org.apache.catalina.core.StandardHost"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Host"</span>);</span><br><span class="line">digester.addRule(prefix + <span class="string">"Host"</span>,<span class="keyword">new</span> CopyParentClassLoaderRule());</span><br><span class="line">digester.addRule(prefix + <span class="string">"Host"</span>,</span><br><span class="line">                 <span class="keyword">new</span> LifecycleListenerRule(<span class="string">"org.apache.catalina.startup.HostConfig"</span>,<span class="string">"hostConfigClass"</span>));</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Host"</span>,<span class="string">"addChild"</span>,<span class="string">"org.apache.catalina.Container"</span>);</span><br><span class="line"></span><br><span class="line">digester.addCallMethod(prefix + <span class="string">"Host/Alias"</span>,<span class="string">"addAlias"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Host添加集群</span></span><br><span class="line"><span class="comment">//Cluster configuration start</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Host/Cluster"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Host/Cluster"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Host/Cluster"</span>,<span class="string">"setCluster"</span>,<span class="string">"org.apache.catalina.Cluster"</span>);</span><br><span class="line"><span class="comment">//Cluster configuration end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Host添加生命周期管理</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Host/Listener"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Host/Listener"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Host/Listener"</span>,<span class="string">"addLifecycleListener"</span>,<span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line"></span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> RealmRuleSet(prefix + <span class="string">"Host/"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Host添加安全配置</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Host/Valve"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Host/Valve"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Host/Valve"</span>,<span class="string">"addValve"</span>,<span class="string">"org.apache.catalina.Valve"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Server-Service-Engine-Host-Context"><a href="#Server-Service-Engine-Host-Context" class="headerlink" title="Server/Service/Engine/Host/Context"></a>Server/Service/Engine/Host/Context</h4><p>11.3. Context的解析</p>
<p>即<code>digester.addRuleSet(new ContextRuleSet(&quot;Server/Service/Engine/Host/&quot;));</code>实际上，它添加了如下规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Context实例，根据create属性的不同而有所区别，这主要是由于Context来源于多处，即静态部署和动态部署。</span></span><br><span class="line"><span class="comment">// 通过server.xml配置Context时，create是true，因此需要创建Context实例；</span></span><br><span class="line"><span class="comment">// 而通过HostConfig自动创建Context时，create为false，此时仅需要解析节点即可。</span></span><br><span class="line"><span class="keyword">if</span> (create) &#123;</span><br><span class="line">	digester.addObjectCreate(prefix + <span class="string">"Context"</span>,<span class="string">"org.apache.catalina.core.StandardContext"</span>, <span class="string">"className"</span>);</span><br><span class="line">	digester.addSetProperties(prefix + <span class="string">"Context"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	digester.addRule(prefix + <span class="string">"Context"</span>, <span class="keyword">new</span> SetContextPropertiesRule());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (create) &#123;</span><br><span class="line">	digester.addRule(prefix + <span class="string">"Context"</span>,</span><br><span class="line">			<span class="keyword">new</span> LifecycleListenerRule(<span class="string">"org.apache.catalina.startup.ContextConfig"</span>,<span class="string">"configClass"</span>));</span><br><span class="line">	digester.addSetNext(prefix + <span class="string">"Context"</span>,<span class="string">"addChild"</span>,<span class="string">"org.apache.catalina.Container"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context添加生命周期监听器</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Listener"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Listener"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Listener"</span>,<span class="string">"addLifecycleListener"</span>,<span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context指定类加载器，默认为org.apache.catalina.loader.WebappLoader,通过className属性可以指定自己的实现类。</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Loader"</span>,<span class="string">"org.apache.catalina.loader.WebappLoader"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Loader"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Loader"</span>,<span class="string">"setLoader"</span>,<span class="string">"org.apache.catalina.Loader"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context添加会话管理器，默认实现为StandardManager，同时为管理器指定会话存储方式和会话标识生成器。</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Manager"</span>,<span class="string">"org.apache.catalina.session.StandardManager"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Manager"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Manager"</span>,<span class="string">"setManager"</span>,<span class="string">"org.apache.catalina.Manager"</span>);</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Manager/Store"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Manager/Store"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Manager/Store"</span>,<span class="string">"setStore"</span>,<span class="string">"org.apache.catalina.Store"</span>);</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Manager/SessionIdGenerator"</span>,</span><br><span class="line">		<span class="string">"org.apache.catalina.util.StandardSessionIdGenerator"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Manager/SessionIdGenerator"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Manager/SessionIdGenerator"</span>,</span><br><span class="line">		<span class="string">"setSessionIdGenerator"</span>,<span class="string">"org.apache.catalina.SessionIdGenerator"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context添加初始化参数</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Parameter"</span>,</span><br><span class="line">		<span class="string">"org.apache.tomcat.util.descriptor.web.ApplicationParameter"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Parameter"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Parameter"</span>,</span><br><span class="line">		<span class="string">"addApplicationParameter"</span>,<span class="string">"org.apache.tomcat.util.descriptor.web.ApplicationParameter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context添加安全配置以及web资源配置</span></span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> RealmRuleSet(prefix + <span class="string">"Context/"</span>));</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Resources"</span>,</span><br><span class="line">		<span class="string">"org.apache.catalina.webresources.StandardRoot"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Resources"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Resources"</span>,<span class="string">"setResources"</span>,<span class="string">"org.apache.catalina.WebResourceRoot"</span>);</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Resources/PreResources"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Resources/PreResources"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Resources/PreResources"</span>,</span><br><span class="line">		<span class="string">"addPreResources"</span>,<span class="string">"org.apache.catalina.WebResourceSet"</span>);</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Resources/JarResources"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Resources/JarResources"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Resources/JarResources"</span>,</span><br><span class="line">		<span class="string">"addJarResources"</span>,<span class="string">"org.apache.catalina.WebResourceSet"</span>);</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Resources/PostResources"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Resources/PostResources"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Resources/PostResources"</span>,</span><br><span class="line">		<span class="string">"addPostResources"</span>,<span class="string">"org.apache.catalina.WebResourceSet"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context添加资源连接</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/ResourceLink"</span>,</span><br><span class="line">		<span class="string">"org.apache.tomcat.util.descriptor.web.ContextResourceLink"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/ResourceLink"</span>);</span><br><span class="line">digester.addRule(prefix + <span class="string">"Context/ResourceLink"</span>,</span><br><span class="line">		<span class="keyword">new</span> SetNextNamingRule(<span class="string">"addResourceLink"</span>,<span class="string">"org.apache.tomcat.util.descriptor.web.ContextResourceLink"</span>));</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/Valve"</span>,<span class="keyword">null</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/Valve"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/Valve"</span>,<span class="string">"addValve"</span>,<span class="string">"org.apache.catalina.Valve"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context添加守护资源配置</span></span><br><span class="line"><span class="comment">// 用于为Context添加监视资源，当这些资源发生变更时，Web应用将会被重新加载，默认为WEB-INF/web.xml</span></span><br><span class="line">digester.addCallMethod(prefix + <span class="string">"Context/WatchedResource"</span>,<span class="string">"addWatchedResource"</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 为Context添加一个生命周期监听类，此类的实例并非添加到Context上，而是添加到Context包含的Wrapper上。</span></span><br><span class="line">digester.addCallMethod(prefix + <span class="string">"Context/WrapperLifecycle"</span>,<span class="string">"addWrapperLifecycle"</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 为Context添加一个容器监听类，此类同样添加到Wrapper上。</span></span><br><span class="line">digester.addCallMethod(prefix + <span class="string">"Context/WrapperListener"</span>,<span class="string">"addWrapperListener"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context添加一个Jar扫描器。JarScanner扫描Web应用和类加载层级的Jar包</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/JarScanner"</span>,</span><br><span class="line">		<span class="string">"org.apache.tomcat.util.scan.StandardJarScanner"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/JarScanner"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/JarScanner"</span>,<span class="string">"setJarScanner"</span>,<span class="string">"org.apache.tomcat.JarScanner"</span>);</span><br><span class="line"></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/JarScanner/JarScanFilter"</span>,</span><br><span class="line">		<span class="string">"org.apache.tomcat.util.scan.StandardJarScanFilter"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/JarScanner/JarScanFilter"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/JarScanner/JarScanFilter"</span>,</span><br><span class="line">		<span class="string">"setJarScanFilter"</span>,<span class="string">"org.apache.tomcat.JarScanFilter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为Context添加Cookie处理器</span></span><br><span class="line">digester.addObjectCreate(prefix + <span class="string">"Context/CookieProcessor"</span>,</span><br><span class="line">		<span class="string">"org.apache.tomcat.util.http.Rfc6265CookieProcessor"</span>,<span class="string">"className"</span>);</span><br><span class="line">digester.addSetProperties(prefix + <span class="string">"Context/CookieProcessor"</span>);</span><br><span class="line">digester.addSetNext(prefix + <span class="string">"Context/CookieProcessor"</span>,</span><br><span class="line">		<span class="string">"setCookieProcessor"</span>,<span class="string">"org.apache.tomcat.util.http.CookieProcessor"</span>);</span><br></pre></td></tr></table></figure>

<p><br><strong>参考：</strong></p>
<ol>
<li><a href="https://www.cnblogs.com/cenyu/p/11079144.html" target="_blank" rel="noopener">https://www.cnblogs.com/cenyu/p/11079144.html</a> </li>
</ol>

      
    </div>
	
    <footer>
      
	  
	    
	<nav id="pagination">
	  
		  <a class="alignleft prev" href="/2017/11/05/20171105/">
		    tomcat. 类加载
		  </a>
	  
	  
	  
		  <a class="alignright next" href="/2017/11/01/20171101/">
		    tomcat. Servlet容器
		  </a>
	  
	  <div class="clearfix"></div>
	</nav>
	
	    
        
  
  <div class="categories">
    <a href="/categories/源码笔记/">源码笔记</a>
  </div>


        
  
  <div class="tags">
    <a href="/tags/tomcat/">tomcat</a>
  </div>


        
  <div class="addthis addthis_toolbox addthis_default_style">
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'd7beb7890a79c73a3e3d',
        clientSecret: '80ea1fc195ae4b80cbd65ec9f1ce68d59595af4b',
        id: md5(window.location.pathname),
        repo: 'shanhm1991.github.io',
        owner: 'shanhm1991',
        admin: 'shanhm1991'
    })
    gitalk.render('gitalk-container')
</script>                              



</div></div>
    <aside id="sidebar" class="alignright">
  


  

  

  

  
<div class="widget catlog">
<h3 class="title">Catlog</h3>
<ul class="entry_catlog">
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引言"><span class="toc-text">引言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Digester"><span class="toc-text">1. Digester</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-Digester结构"><span class="toc-text">1.1. Digester结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Digester实现"><span class="toc-text">1.2. Digester实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-startDocument"><span class="toc-text">1.2.1. startDocument</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-startElement"><span class="toc-text">1.2.2. startElement</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3-characters"><span class="toc-text">1.2.3. characters</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-4-endElement"><span class="toc-text">1.2.4. endElement</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-5-endDocument"><span class="toc-text">1.2.5. endDocument</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Rule实现"><span class="toc-text">3. Rule实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-ObjectCreateRule"><span class="toc-text">3.1. ObjectCreateRule</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-SetPropertiesRule"><span class="toc-text">3.2. SetPropertiesRule</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-SetNextRule"><span class="toc-text">3.3. SetNextRule</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-server-xml加载"><span class="toc-text">4. server.xml加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Server"><span class="toc-text">Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-Listener"><span class="toc-text">Server&#x2F;Listener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-Service"><span class="toc-text">Server&#x2F;Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-Service-Executor"><span class="toc-text">Server&#x2F;Service&#x2F;Executor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-Service-Connector"><span class="toc-text">Server&#x2F;Service&#x2F;Connector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-Service-Engine"><span class="toc-text">Server&#x2F;Service&#x2F;Engine</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-Service-Engine-Host"><span class="toc-text">Server&#x2F;Service&#x2F;Engine&#x2F;Host</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-Service-Engine-Host-Context"><span class="toc-text">Server&#x2F;Service&#x2F;Engine&#x2F;Host&#x2F;Context</span></a></li></ol></li></ol></li></ol>
</div>




</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">

  
  
      &copy; 2021 shanhm1991 
  
  
  
  <font style="float: right">
</div>
<div class="clearfix"></div>
</footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
