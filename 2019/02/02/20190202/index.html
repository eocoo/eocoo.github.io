<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>《深入理解java虚拟机》. 笔记八（类加载） | Essay</title>
  <meta name="author" content="shanhm1991">
  
  <meta name="description" content="引言">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="《深入理解java虚拟机》. 笔记八（类加载）"/>
  <meta property="og:site_name" content="Essay"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Essay" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-147251181-1', 'auto');
	ga('send', 'pageview');

</script>


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header id="header" class="inner"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="alignleft">
  <h1><a href="/">Essay</a></h1>
  <span style="color:#ADA5A0; height:20px;line-height:30px;">不人云亦云，不断章取义</span>
  <h2><font style="color: #999;">articles:  91 &nbsp;&nbsp;&nbsp; views: <span id="busuanzi_value_site_uv"></span></font></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/about">Abount</a></li>
    
      <li><a href="/books">Books</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>

<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-20190202" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2019-02-01T16:00:00.000Z"><a href="/2019/02/02/20190202/">2019-02-02</a></time>
      
      

  
  
    <h1 class="p-name title" itemprop="headline name">
        《深入理解java虚拟机》. 笔记八（类加载）
    </h1>
    
    
       <div class="title" style="padding: 5px 0px 20px 10px; color: #766;">
            ———— Java SE 7
       </div> 
    
  
  
  


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


   <font style="color: #999;"> words: 5.9k  &nbsp;&nbsp; views: <span id="busuanzi_value_page_pv"></span> &nbsp;&nbsp; time: 25min</font>
   
   
  
  <div class="categories">
    <a href="/categories/读书笔记/">读书笔记</a>
  </div>


   
   
  
  <div class="tags">
    <a href="/tags/Class/">Class</a>
  </div>


   
   <hr style="background-color: #ddd; height:1px; border:none;" /><br>
   


    </header>
      
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><a id="more"></a>







<h4 id="1-4-解析"><a href="#1-4-解析" class="headerlink" title="1.4. 解析"></a>1.4. 解析</h4><p>解析就是虚拟机<font color="#E51508">将常量池内的符号引用替换为直接引用的过程</font>，所以可以理解为对符合引用的解析。<br><strong>符号引用</strong>即以一组符号来描述所引用的目标，符号可以上任何形式的字面量，只要使用时能无歧义地定位到目标即可。<br><strong>直接引用</strong>可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄，总之引用的目标必定已经在内存中存在。</p>
<p>虚拟机规范并未对什么时候进行解析阶段有规定，只要求了在执行<code>anewarray</code>、<code>checkcast</code>、<code>getfield</code>、<code>getstatic</code>、<code>instanceof</code>、
<code>invokedynamic</code>、<code>invokeinterface</code>、<code>invokespecial</code>、<code>invokeestatic</code>、<code>involevirtual</code>、<code>ldc</code>、<code>ldc_w</code>、<code>multianewarray</code>、<code>new</code>、
<code>putstatic</code>和<code>putfield</code>这16个用于操作符号引用的字节码指令之前，先对他们所使用的符号引用进行解析。</p>
<p>其中，除了<code>invokedynamic</code>之外，虚拟机可以对其它指令第一次解析的结果进行缓存，即在运行时常量池中记录直接引用，
并标识为已解析状态，从而避免解析动作重复进行。而<code>invokedynamic</code>的本意用于动态语言支持，必须等到程序实际运行到这条指令时才进行解析。</p>
<p>解析动作主要针对：类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用进行解析。<br><strong>类或接口的解析</strong><br>假设当前代码所处的类为D，如果想把一个从未解析过的符号引用N解析到一个类或接口C的直接引用，虚拟机完成整个解析阶段的过程分为以下3步：</p>
<ol>
<li>如果C是不是一个数组类型，虚拟机将会把符号引用N的全项定类名传递给D的类加载器去加载这个类C。在加载的过程中由于需要验证，
可能又会触发其他类的加载，一当加载过程出现错误，解析过程直接失败。</li>
<li>如果C是一个数组类型，数组元素也是对象类型的话，N的描述符将会是类似<code>[Ljava/lang/Integer</code>的形式。
那将会按照第一点的规则加载数组元素类型，接着由虚拟机生成一个代表此数组维度和元素的数组对象</li>
<li>如果前面的步骤都没有出现错误，在解析完成前还需要进行符号引用的验证，确认D是否具备对C的访问权限，如果D没有对C的访问权限，
抛出java.lang.IllegalAccessEroor异常。</li>
</ol>
<p><strong>字段解析</strong><br>要解析一个未被解析过的字段的符号引用。首先会对字段表内的class_index项索引的CONSTANT_Class_info符号引用解析，
也就是字段所属的类或接口的符号引用。如果在解析这个类或接口的符号引用出现异常，都会导致字段解析的失败。
如果这个类或接口解析成功，将这个字段所属的类或接口用C表示，然后对C进行后续的字段搜索</p>
<ol>
<li>如果C本身就包含了简单名称和字段描述符都与目标字段相同的字段，则返回这个字段的直接引用，查找结束</li>
<li>否则，如果在C中实现了接口，将会按照继承关系从下往上递归搜索每个接口和它的父接口，然后按照步骤1去查找</li>
<li>否则，如果C不是object类的话，按照继承关系从下往上递归搜索其父类，然后按照步骤1去查找</li>
<li>否则，查找失败，抛出java.lang.NoSuchFieldError异常。</li>
</ol>
<p><strong>类方法解析</strong><br>类方的解析的第一个步骤与字段解析一样，也需要先解析出类方法表的claaa_index索引的方法所属类或接口的符号引用.如果解析成功，
用C表示这个类，接下来虚拟机按照以下步骤进行类方法的搜索：</p>
<ol>
<li>在类C中查找是否有简单名称和描述符都与目标匹配的方法，如果有返回这个方法的直接引用，查找结束</li>
<li>否则在类C的父类中递归查找</li>
<li>否则在类C的接口或父接口中查找</li>
<li>否则查找失败，抛出java.lang.NoSuchMethodError异常。</li>
</ol>
<h4 id="1-5-初始化"><a href="#1-5-初始化" class="headerlink" title="1.5. 初始化"></a>1.5. 初始化</h4><p>前面的加载过程中，除了在加载阶段应用程序可以自定义加载器参与类的加载过程外，其余的动作完全由虚拟机主导和控制。
到了初始化阶段，才真正开始执行类中定义的Java代码。</p>
<p>在准备阶段，变量已经被赋值为类型的零值，而在初始化阶段，则根据程序制定的主观计划去初始化类变量和其他资源，
即<font color="#E51508">初始化阶段是执行类构造器方法<code>&lt;cinit&gt;()</code>的过程</font>。</p>
<p><code>&lt;cinit&gt;()</code>方法是由编译器自动收集类中的所有类变量的赋值操作和静态语句块<code>static{}</code>中的所有语句合并而生的，因此，它不是必须的。
静态语句块只能访问到定义在静态语句前的变量，对于定义在它之后的变量，只能赋值而不能访问。</p>
<p>另外，虚拟机会保证在执行子类的<code>&lt;cinit&gt;()</code>之前，父类的<code>&lt;cinit&gt;()</code>已经执行完毕。不过，
执行接口的<code>&lt;cinit&gt;()</code>不需要先执行父接口的<code>&lt;cinit&gt;()</code>，接口实现类在初始化时也一样不需要执行父接口的<code>&lt;cinit&gt;()</code>，
只有当父接口中定义的变量使用时，父接口才会初始化。<br>特别的，虚拟机会保证一个类的<code>&lt;cinit&gt;()</code>在多线程环境中被正确的加锁、同步。如果多线程同时去初始化一个类，那么只会有一个线程执行，
其他线程都需要阻塞等待，直到初始化完毕。要注意的是，其他线程虽然会被阻塞，但在执行<code>&lt;cinit&gt;()</code>的线程退出之后，
它们也不会再进入<code>&lt;cinit&gt;()</code>方法。即同一个类加载器下，一个类型只会初始化一次。</p>
<h3 id="2-类加载器"><a href="#2-类加载器" class="headerlink" title="2. 类加载器"></a>2. 类加载器</h3><font color="#E51508">
虚拟机设计者将类加载过程中的加载动作放到虚拟机外部去实现，以便让应用程序自己决定如何去获取所需要的类，
实现这个动作的代码模块便称为类加载器。
</font> 

<p>因此，类加载器的任务便是根据一个类的全限定名来读取此类的二进制字节流到JVM中，
然后转换为一个与目标类对应的java.lang.Class对象实例。<font color="#E51508">对于任意一个类，
都需要由加载它的类加载器和这个类本身一同确立其在java虚拟机中唯一性，每一个类加载器，都拥有一个独立的类名称空间。</font></p>
<p>虚拟机提供了3种类加载器：</p>
<ol>
<li>启动类加载器（Bootstrap）</li>
</ol>
<p>启动类加载器主要加载的是JVM自身需要的类，这个类加载使用C++语言实现的，是虚拟机自身的一部分，
它负责将 <code>&lt;JAVA_HOME&gt;/lib</code>路径下的核心类库或<code>-Xbootclasspath</code>参数指定的路径下的jar包加载到内存中，
注意虚拟机是按照文件名识别加载jar包的，如rt.jar，如果文件名不被虚拟机识别，
即使把jar包丢到lib目录下也是没有作用的(出于安全考虑，Bootstrap启动类加载器只加载包名为java、javax、sun等开头的类)。</p>
<ol start="2">
<li>扩展类加载器（ExtClassLoader）</li>
</ol>
<p>它负责加载<code>&lt;JAVA_HOME&gt;/lib/ext</code>目录下或者由系统变量<code>-Djava.ext.dir</code>指定位路径中的类库，
开发者可以直接使用标准扩展类加载器。</p>
<ol start="3">
<li>应用程序类加载器（AppClassLoader）</li>
</ol>
<p>它负责加载classpath路径下的类库，开发者可以直接使用系统类加载器，
一般情况下该类加载是程序中默认的类加载器，通过<code>ClassLoader.getSystemClassLoader()</code>可以获取到该类加载器。</p>
<h4 id="2-1-双亲委派模式"><a href="#2-1-双亲委派模式" class="headerlink" title="2.1. 双亲委派模式"></a>2.1. 双亲委派模式</h4><p>在日常应用程序开发中，类的加载都是由上述3种类加载器相互配合执行的，必要时，也可以自定义类加载器。
它们直接存在着父子关系，不过不是通过继承实现的，而是通过组合的方式，如下称为双亲委派模型：</p>
<p><img src="/img/20190202/20190202.1.jpg" alt=""></p>
<p>双亲委派模式是在Java 1.2后引入的，其工作原理的是，如果一个类加载器收到了类加载请求，它并不会自己先去加载，
而是把这个请求委托给父类的加载器去执行，如果父类加载器还存在其父类加载器，则进一步向上委托，依次递归，
请求最终将到达顶层的启动类加载器，如果父类加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，
子加载器才会尝试自己去加载。</p>
<p>使用双亲委派模式的是好处是Java类随着它的类加载器一起具备了一种带有优先级的层次关系，通过这种层级关可以避免类的重复加载，
当父亲已经加载了该类时，就没有必要子ClassLoader再加载一次。<br>其次考虑到安全因素，java核心api中定义类型不会被随意替换，假设通过网络传递一个名为java.lang.Integer的类，
通过双亲委托模式传递到启动类加载器，而启动类加载器发现该类已被加载，则直接返回已加载过的Integer.class，
这样便可以防止核心API库被篡改。</p>
<h4 id="2-2-ClassLoader"><a href="#2-2-ClassLoader" class="headerlink" title="2.2. ClassLoader"></a>2.2. ClassLoader</h4><p><img src="/img/20190202/20190202.2.jpg" alt=""></p>
<p>下面通过代码来简单看一下ClassLoader的实现：<font color="#E51508"><code>ClassLoader</code>本身是一个抽象父类，
对于类加载实现它提供了一个模板方法<code>loadClass</code>，统一使用双亲委派模式进行加载。然后将其中的<code>findClass</code>过程交给子类实现，
当然也可以直接覆盖掉<code>loadClass</code>，但是不建议。另外，它强制所有构造器必须指定一个父类加载器<code>parent</code>，
确保<code>loadClass</code>中双亲委派模式的进行，如果是无参构造器，则默认指定为<code>AppClassLoader</code>。</font></p>
<p>先看下<code>loadClass</code>过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">		<span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">		Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">		<span class="comment">//如果缓存中没有找到，则进行加载</span></span><br><span class="line">		<span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">			<span class="comment">//尝试向上委托给父类进行加载，一直到启动类加载器</span></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">					c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					c = findBootstrapClassOrNull(name);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">				<span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">				<span class="comment">// from the non-null parent class loader</span></span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//如果parent加载不到，则自己进行加载</span></span><br><span class="line">			<span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">				<span class="comment">// to find the class.</span></span><br><span class="line">				<span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">				c = findClass(name);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">				sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">				sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">				sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//加载之后是否进行解析</span></span><br><span class="line">		<span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">			resolveClass(c);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> c;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看一下默认的<code>parent</code>是怎么来的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(checkCreateClassLoader(), getSystemClassLoader());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getSystemClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    initSystemClassLoader();</span><br><span class="line">    <span class="keyword">if</span> (scl == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SecurityManager sm = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        checkClassLoaderPermission(scl, Reflection.getCallerClass());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> scl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//systemClassLoader即应用程序类加载器</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ClassLoader scl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> sclSet;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initSystemClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sclSet) &#123;</span><br><span class="line">        <span class="keyword">if</span> (scl != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"recursive invocation"</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//从Launcher唯一的实例中获取AppClassLoader唯一的实例</span></span><br><span class="line">        sun.misc.Launcher l = sun.misc.Launcher.getLauncher();</span><br><span class="line">        <span class="keyword">if</span> (l != <span class="keyword">null</span>) &#123;          </span><br><span class="line">            scl = l.getClassLoader();</span><br><span class="line">			</span><br><span class="line">			Throwable oops = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                scl = AccessController.doPrivileged(</span><br><span class="line">                    <span class="keyword">new</span> SystemClassLoaderAction(scl));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">                oops = pae.getCause();</span><br><span class="line">                <span class="keyword">if</span> (oops <span class="keyword">instanceof</span> InvocationTargetException) &#123;</span><br><span class="line">                    oops = oops.getCause();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (oops != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (oops <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (Error) oops;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// wrap the exception</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(oops);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sclSet = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-Launcher"><a href="#2-3-Launcher" class="headerlink" title="2.3. Launcher"></a>2.3. Launcher</h4><p>接着看一下<code>Launcher</code>以及它里面的<code>AppClassLoader</code>是怎么创建的，如注释所言：
<font color="#E51508">Launcher是java应用的入口，由JVM创建，它类加载器应该是BootStrapClassLoade。
在它的构造器中，分别创建了<code>ExtClassLoader</code>和<code>AppClassLoader</code>，并将<code>AppClassLoader</code>的<code>parent</code>置为<code>AppClassLoader</code>，
这样结合上面的<code>loadClass</code>实现，那就是一个双亲委派模型了。</font> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//This class is used by the system to launch the main application</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> URLStreamHandlerFactory factory = <span class="keyword">new</span> Factory();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Launcher launcher = <span class="keyword">new</span> Launcher();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String bootClassPath = System.getProperty(<span class="string">"sun.boot.class.path"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ClassLoader loader;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Launcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Create the extension class loader</span></span><br><span class="line">		ClassLoader extcl;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			extcl = ExtClassLoader.getExtClassLoader();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"Could not create extension class loader"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now create the class loader to use to launch the application</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			loader = AppClassLoader.getAppClassLoader(extcl);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"Could not create application class loader"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Also set the context class loader for the primordial thread.</span></span><br><span class="line">		Thread.currentThread().setContextClassLoader(loader);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Finally, install a security manager if requested</span></span><br><span class="line">		String s = System.getProperty(<span class="string">"java.security.manager"</span>);</span><br><span class="line">		<span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">			SecurityManager sm = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">if</span> (<span class="string">""</span>.equals(s) || <span class="string">"default"</span>.equals(s)) &#123;</span><br><span class="line">				sm = <span class="keyword">new</span> java.lang.SecurityManager();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					sm = (SecurityManager)loader.loadClass(s).newInstance();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">				System.setSecurityManager(sm);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"Could not create SecurityManager: "</span> + s);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-1-ExtClassLoader"><a href="#2-3-1-ExtClassLoader" class="headerlink" title="2.3.1. ExtClassLoader"></a>2.3.1. ExtClassLoader</h5><p><code>ExtClassLoader</code>默认加载默认加载<code>JAVA_HOME/jre/lib/ext/下的包</code>，或者由<code>java.ext.dirs</code>指定目录下的包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Creates a new ExtClassLoader for the specified directories.</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ExtClassLoader</span><span class="params">(File[] dirs)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(getExtURLs(dirs), <span class="keyword">null</span>, factory);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> URL[] getExtURLs(File[] dirs) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		Vector&lt;URL&gt; urls = <span class="keyword">new</span> Vector&lt;URL&gt;();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dirs.length; i++) &#123;</span><br><span class="line">			String[] files = dirs[i].list();</span><br><span class="line">			<span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; files.length; j++) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!files[j].equals(<span class="string">"meta-index"</span>)) &#123;</span><br><span class="line">						File f = <span class="keyword">new</span> File(dirs[i], files[j]);</span><br><span class="line">						urls.add(getFileURL(f));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		URL[] ua = <span class="keyword">new</span> URL[urls.size()];</span><br><span class="line">		urls.copyInto(ua);</span><br><span class="line">		<span class="keyword">return</span> ua;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * create an ExtClassLoader. The ExtClassLoader is created</span></span><br><span class="line"><span class="comment">	 * within a context that limits which files it can read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExtClassLoader <span class="title">getExtClassLoader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> File[] dirs = getExtDirs();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// Prior implementations of this doPrivileged() block supplied</span></span><br><span class="line">			<span class="comment">// aa synthesized ACC via a call to the private method</span></span><br><span class="line">			<span class="comment">// ExtClassLoader.getContext().</span></span><br><span class="line">			<span class="keyword">return</span> AccessController.doPrivileged(</span><br><span class="line">					<span class="keyword">new</span> PrivilegedExceptionAction&lt;ExtClassLoader&gt;() &#123;</span><br><span class="line">						<span class="function"><span class="keyword">public</span> ExtClassLoader <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">							<span class="keyword">int</span> len = dirs.length;</span><br><span class="line">							<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">								MetaIndex.registerDirectory(dirs[i]);</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">return</span> <span class="keyword">new</span> ExtClassLoader(dirs);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (java.security.PrivilegedActionException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> (IOException) e.getException();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> File[] getExtDirs() &#123;</span><br><span class="line">		String s = System.getProperty(<span class="string">"java.ext.dirs"</span>);</span><br><span class="line">		File[] dirs;</span><br><span class="line">		<span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">			StringTokenizer st = <span class="keyword">new</span> StringTokenizer(s, File.pathSeparator);</span><br><span class="line">			<span class="keyword">int</span> count = st.countTokens();</span><br><span class="line">			dirs = <span class="keyword">new</span> File[count];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">				dirs[i] = <span class="keyword">new</span> File(st.nextToken());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			dirs = <span class="keyword">new</span> File[<span class="number">0</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> dirs;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-2-AppClassLoader"><a href="#2-3-2-AppClassLoader" class="headerlink" title="2.3.2. AppClassLoader"></a>2.3.2. AppClassLoader</h5><p>最后是<code>AppClassLoader</code>，它就是加载<code>java.class.path</code>目录下class，即应用程序的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AppClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		ClassLoader.registerAsParallelCapable();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getAppClassLoader</span><span class="params">(<span class="keyword">final</span> ClassLoader extcl)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> String s = System.getProperty(<span class="string">"java.class.path"</span>);</span><br><span class="line">		<span class="keyword">final</span> File[] path = (s == <span class="keyword">null</span>) ? <span class="keyword">new</span> File[<span class="number">0</span>] : getClassPath(s);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Note: on bugid 4256530</span></span><br><span class="line">		<span class="comment">// Prior implementations of this doPrivileged() block supplied</span></span><br><span class="line">		<span class="comment">// a rather restrictive ACC via a call to the private method</span></span><br><span class="line">		<span class="comment">// AppClassLoader.getContext(). This proved overly restrictive</span></span><br><span class="line">		<span class="comment">// when loading  classes. Specifically it prevent</span></span><br><span class="line">		<span class="comment">// accessClassInPackage.sun.* grants from being honored.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="keyword">return</span> AccessController.doPrivileged(</span><br><span class="line">				<span class="keyword">new</span> PrivilegedAction&lt;AppClassLoader&gt;() &#123;</span><br><span class="line">					<span class="function"><span class="keyword">public</span> AppClassLoader <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">						URL[] urls =</span><br><span class="line">								(s == <span class="keyword">null</span>) ? <span class="keyword">new</span> URL[<span class="number">0</span>] : pathToURLs(path);</span><br><span class="line">								<span class="keyword">return</span> <span class="keyword">new</span> AppClassLoader(urls, extcl);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Creates a new AppClassLoader</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	AppClassLoader(URL[] urls, ClassLoader parent) &#123;</span><br><span class="line">		<span class="keyword">super</span>(urls, parent, factory);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Override loadClass so we can checkPackageAccess.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">		<span class="keyword">int</span> i = name.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">		<span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">			SecurityManager sm = System.getSecurityManager();</span><br><span class="line">			<span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">				sm.checkPackageAccess(name.substring(<span class="number">0</span>, i));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">super</span>.loadClass(name, resolve));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-3-ContextClassLoader"><a href="#2-3-3-ContextClassLoader" class="headerlink" title="2.3.3. ContextClassLoader"></a>2.3.3. ContextClassLoader</h5><p>双亲委派可以很好的解决各个类加载器加载的类的统一问题，<font color="#E51508">但如果父加载器加载的类想去调用子加载器加载的类，
那么将出现问题。比如java中提供的一些spi（service provider interface），当调用具体的实现时，
如果这些具体实现类的class直接默认使用当前类<code>Caller</code>的加载器（即spi的加载器BootstrapClassLoader）进行加载，那么肯定失败。</p>
<p>因此，为了解决这个问题，java设计团队引入了一个不太优雅的设计<code>ContextClassLoader</code>，可以从<code>currentThread</code>中获取。
上面<code>Launcher</code>在构造器中已经设置过<code>currentThread</code>的默认值为<code>AppClassLoader</code>，后面子线程在创建时将默认设置为父线程的<code>ContextClassLoader</code>，
所以，如果在spi的调用时显示地指定具体的类加载器（默认即<code>AppClassLoader</code>，当然也可以通过set进行覆盖）进行加载，那么便可以解决问题了。</p>
<p>其实，相当于重置了一下加载器的起点，因为spi自身的加载器起点已经很高了，它只能继续向上寻找，那肯定找不到。
因此，如果它希望找到低层加载器加载的类，可以通过<code>ContextClassLoader</code>获取到最低层的AppClassLoader，
这样就能获取到<code>AppClassLoader</code>加载的实现类了。</font></p>
<h3 id="3-示例"><a href="#3-示例" class="headerlink" title="3. 示例"></a>3. 示例</h3><h4 id="3-1-DriverManager"><a href="#3-1-DriverManager" class="headerlink" title="3.1. DriverManager"></a>3.1. DriverManager</h4><p>JDBC(Java Database Connectivity)是java提供给各数据库厂商的spi，它使用驱动程序管理器并指定数据库的驱动程序来提供与异构数据库的透明连接。
JDBC驱动程序管理器确保使用正确的驱动程序来访问每个数据源，并能够支持连接到多个异构数据库的多个并发驱动程序。<br>下图展示了驱动程序管理器相对于JDBC驱动程序和Java应用程序的位置：</p>
<p><img src="/img/20190202/20190202.3.jpg" alt=""></p>
<p>其API主要提供以下接口：</p>
<ul>
<li><p><code>DriverManager</code>：此类管理数据库驱动程序列表。使用通信子协议将来自java应用程序的连接请求与适当的数据库驱动程序进行匹配。
在JDBC下识别某个子协议的第一个驱动程序将用于建立数据库连接。</p>
</li>
<li><p><code>Driver</code>：此接口处理与数据库服务器的通信。我们很少会直接与Driver对象进行交互。但会使用DriverManager对象来管理这种类型的对象。
它还提取与使用Driver对象相关的信息。</p>
</li>
<li><p><code>Connection</code>：此接口具有用于联系数据库的所有方法。连接(Connection)对象表示通信上下文，即与数据库的所有通信仅通过连接对象。</p>
</li>
<li><p><code>Statement</code>：使用从此接口创建的对象将SQL语句提交到数据库。除了执行存储过程之外，一些派生接口还接受参数。</p>
</li>
<li><p><code>ResultSet</code>：在使用Statement对象执行SQL查询后，这些对象保存从数据库检索的数据。它作为一个迭代器并可移动ResultSet对象查询的数据。</p>
</li>
<li><p><code>SQLException</code>：此类处理数据库应用程序中发生的任何错误。</p>
</li>
</ul>
<p>这里主要讲一下<strong>驱动类的加载和注册</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection con = DriverManager.getConnection(url, user, passwd)</span><br></pre></td></tr></table></figure>

<p>所有的数据库访问得从获取连接开始，但是各数据库具体怎么连接只有其自己的厂商清楚，因此，
<font color="#E51508">java要求各数据库厂商提供其对应的java驱动，并要求它们自己将自己注册到驱动管理器中。</font></p>
<figure class="highlight java"><figcaption><span class="caption">com.mysql.jdbc.Driver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span> <span class="keyword">extends</span> <span class="title">NonRegisteringDriver</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">sql</span>.<span class="title">Driver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.sql.DriverManager.registerDriver(<span class="keyword">new</span> Driver());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException E) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can't register driver!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Driver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">// Required for Class.forName().newInstance()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如这里mysql的驱动，它在静态域中将自己注册到了<code>DriverManager</code>中。
但有一个问题：<font color="#E51508">这个静态域怎么调用呢，即这个类如何加载？</font>
如它在构造器中的注释说明：需要进行显示的类加载。</p>
<figure class="highlight java"><figcaption><span class="caption">java.sql.DriverManager</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DriverManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		loadInitialDrivers();</span><br><span class="line">		println(<span class="string">"JDBC DriverManager initialized"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadInitialDrivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String drivers;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			drivers = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;String&gt;() &#123;</span><br><span class="line">				<span class="function"><span class="keyword">public</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					<span class="keyword">return</span> System.getProperty(<span class="string">"jdbc.drivers"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			drivers = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// If the driver is packaged as a Service Provider, load it.</span></span><br><span class="line">		<span class="comment">// Get all the drivers through the classloader</span></span><br><span class="line">		<span class="comment">// exposed as a java.sql.Driver.class service.</span></span><br><span class="line">		<span class="comment">// ServiceLoader.load() replaces the sun.misc.Providers()</span></span><br><span class="line"></span><br><span class="line">		AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line marked">				ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">				Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* Load these drivers, so that they can be instantiated.</span></span><br><span class="line"><span class="comment">				 * It may be the case that the driver class may not be there</span></span><br><span class="line"><span class="comment">				 * i.e. there may be a packaged driver with the service class</span></span><br><span class="line"><span class="comment">				 * as implementation of java.sql.Driver but the actual class</span></span><br><span class="line"><span class="comment">				 * may be missing. In that case a java.util.ServiceConfigurationError</span></span><br><span class="line"><span class="comment">				 * will be thrown at runtime by the VM trying to locate</span></span><br><span class="line"><span class="comment">				 * and load the service.</span></span><br><span class="line"><span class="comment">				 *</span></span><br><span class="line"><span class="comment">				 * Adding a try catch block to catch those runtime errors</span></span><br><span class="line"><span class="comment">				 * if driver not available in classpath but it's</span></span><br><span class="line"><span class="comment">				 * packaged as service and that service is there in classpath.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				<span class="keyword">try</span>&#123;</span><br><span class="line">					<span class="keyword">while</span>(driversIterator.hasNext()) &#123;</span><br><span class="line">						driversIterator.next();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span>(Throwable t) &#123;</span><br><span class="line">					<span class="comment">// Do nothing</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		println(<span class="string">"DriverManager.initialize: jdbc.drivers = "</span> + drivers);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (drivers == <span class="keyword">null</span> || drivers.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		String[] driversList = drivers.split(<span class="string">":"</span>);</span><br><span class="line">		println(<span class="string">"number of Drivers:"</span> + driversList.length);</span><br><span class="line">		<span class="keyword">for</span> (String aDriver : driversList) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				println(<span class="string">"DriverManager.Initialize: loading "</span> + aDriver);</span><br><span class="line">				Class.forName(aDriver, <span class="keyword">true</span>, ClassLoader.getSystemClassLoader());</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				println(<span class="string">"DriverManager.Initialize: load failed: "</span> + ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span class="caption">java.util.ServiceLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoader</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Class&lt;S&gt; service;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ClassLoader loader;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> LinkedHashMap&lt;String,S&gt; providers = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> LazyIterator lookupIterator;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service)</span> </span>&#123;</span><br><span class="line marked">		ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line marked">		<span class="keyword">return</span> ServiceLoader.load(service, cl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service, ClassLoader loader)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ServiceLoader&lt;&gt;(service, loader);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ServiceLoader</span><span class="params">(Class&lt;S&gt; svc, ClassLoader cl)</span> </span>&#123;</span><br><span class="line">		service = Objects.requireNonNull(svc, <span class="string">"Service interface cannot be null"</span>);</span><br><span class="line">		loader = (cl == <span class="keyword">null</span>) ? ClassLoader.getSystemClassLoader() : cl;</span><br><span class="line">		acc = (System.getSecurityManager() != <span class="keyword">null</span>) ? AccessController.getContext() : <span class="keyword">null</span>;</span><br><span class="line">		reload();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		providers.clear();</span><br><span class="line">		lookupIterator = <span class="keyword">new</span> LazyIterator(service, loader);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">		Class&lt;S&gt; service;</span><br><span class="line">		ClassLoader loader;</span><br><span class="line">		Enumeration&lt;URL&gt; configs = <span class="keyword">null</span>;</span><br><span class="line">		Iterator&lt;String&gt; pending = <span class="keyword">null</span>;</span><br><span class="line">		String nextName = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">LazyIterator</span><span class="params">(Class&lt;S&gt; service, ClassLoader loader)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.service = service;</span><br><span class="line">			<span class="keyword">this</span>.loader = loader;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasNextService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (nextName != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (configs == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					String fullName = PREFIX + service.getName();</span><br><span class="line">					<span class="keyword">if</span> (loader == <span class="keyword">null</span>)</span><br><span class="line marked">						configs = ClassLoader.getSystemResources(fullName);</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line marked">						configs = loader.getResources(fullName);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">					fail(service, <span class="string">"Error locating configuration files"</span>, x);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">while</span> ((pending == <span class="keyword">null</span>) || !pending.hasNext()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!configs.hasMoreElements()) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				pending = parse(service, configs.nextElement());</span><br><span class="line">			&#125;</span><br><span class="line">			nextName = pending.next();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> S <span class="title">nextService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (!hasNextService())</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">			String cn = nextName;</span><br><span class="line">			nextName = <span class="keyword">null</span>;</span><br><span class="line">			Class&lt;?&gt; c = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line marked">				c = Class.forName(cn, <span class="keyword">false</span>, loader);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (ClassNotFoundException x) &#123;</span><br><span class="line">				fail(service, <span class="string">"Provider "</span> + cn + <span class="string">" not found"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!service.isAssignableFrom(c)) &#123;</span><br><span class="line">				fail(service, <span class="string">"Provider "</span> + cn  + <span class="string">" not a subtype"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				S p = service.cast(c.newInstance());</span><br><span class="line">				providers.put(cn, p);</span><br><span class="line">				<span class="keyword">return</span> p;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">				fail(service, <span class="string">"Provider "</span> + cn + <span class="string">" could not be instantiated: "</span> + x, x);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> Error();          <span class="comment">// This cannot happen</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，<font color="#E51508"><code>DriverManager</code>首先会在静态域中，
即获取连接之前通过<code>ContextClassLoader</code>加载所有能加载到的驱动，如果不指定即默认为<code>AppClassLoader</code>，
也就是加载classpath下的所有Driver。</font><br><code>ServiceLoader.load</code>是一个静态工具，可以试一下将<code>ContextClassLoader</code>设为加载器的parent，那么将会发现加载不到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String []arg)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException</span>&#123;</span><br><span class="line">	System.out.println(<span class="string">"contextloader: "</span> + Thread.currentThread().getContextClassLoader());</span><br><span class="line">	ServiceLoader&lt;Driver&gt; loader = ServiceLoader.load(Driver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	Iterator&lt;Driver&gt; iterator = loader.iterator();</span><br><span class="line">	<span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">		Driver driver = (Driver) iterator.next();</span><br><span class="line">		System.out.println(driver.getClass());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ContextClassLoader: sun.misc.Launcher$AppClassLoader@73d16e93</span><br><span class="line">class oracle.jdbc.OracleDriver</span><br><span class="line">class com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>

<p>因此，在<code>DriverManager</code>可以看到这样一段注释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * ...</span><br><span class="line"> * Applications no longer need to explicitly load JDBC drivers using Class.forName(). Existing programs</span><br><span class="line"> * which currently load JDBC drivers using Class.forName() will continue to work without modification.</span><br><span class="line"> * ...</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>
<p>即<font color="#E51508">不需要再像以前一下在获取连接之前首先必须手动加载驱动了</font>，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>)</span><br><span class="line">Connection con = DriverManager.getConnection(url, user, passwd)</span><br></pre></td></tr></table></figure>

<p>那么，<font color="#E51508">它怎么知道有哪些驱动可以加载的呢？</font>方法是通过<code>ClassLoader.getResources</code>，       
其实，很多时候配置文件都可以通过<code>classLoader.getResourceAsStream(&quot;conf.properties&quot;);</code>的方式来进行加载。<br>有意思的是：<code>getResources</code>的实现也是双亲委派模式，而<code>getSystemResources</code>则是默认尝试从<code>AppClassLoader</code>开始，
也正因如此，它才能找到类路径下所有的Driver。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">getResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	Enumeration&lt;URL&gt;[] tmp = (Enumeration&lt;URL&gt;[]) <span class="keyword">new</span> Enumeration&lt;?&gt;[<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">		tmp[<span class="number">0</span>] = parent.getResources(name);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		tmp[<span class="number">0</span>] = getBootstrapResources(name);</span><br><span class="line">	&#125;</span><br><span class="line">	tmp[<span class="number">1</span>] = findResources(name);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> CompoundEnumeration&lt;&gt;(tmp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Enumeration&lt;URL&gt; <span class="title">getSystemResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	ClassLoader system = getSystemClassLoader();</span><br><span class="line">	<span class="keyword">if</span> (system == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> getBootstrapResources(name);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> system.getResources(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br><strong>参考：</strong></p>
<ol>
<li>Copyright&nbsp;&copy;《深入理解java虚拟机》</li>
<li><a href="https://blog.csdn.net/javazejian/article/details/73413292" target="_blank" rel="noopener">https://blog.csdn.net/javazejian/article/details/73413292</a></li>
<li><a href="https://www.jianshu.com/p/a4dc755652ff" target="_blank" rel="noopener">https://www.jianshu.com/p/a4dc755652ff</a> </li>
<li><a href="https://www.yiibai.com/jdbc/jdbc-introduction.html" target="_blank" rel="noopener">https://www.yiibai.com/jdbc/jdbc-introduction.html</a> </li>
</ol>

      
    </div>
	
    <footer>
      
	  
	    
	<nav id="pagination">
	  
		  <a class="alignleft prev" href="/2019/02/15/20190215/">
		    《深入理解java虚拟机》. 笔记九（内存模型）
		  </a>
	  
	  
	  
		  <a class="alignright next" href="/2019/01/31/20190131/">
		    《深入理解java虚拟机》. 笔记六（Jvm监控与故障处理工具）
		  </a>
	  
	  <div class="clearfix"></div>
	</nav>
	
	    
        
  
  <div class="categories">
    <a href="/categories/读书笔记/">读书笔记</a>
  </div>


        
  
  <div class="tags">
    <a href="/tags/Class/">Class</a>
  </div>


        
  <div class="addthis addthis_toolbox addthis_default_style ">
    
    
      <a class="addthis_button_tweet"></a>
    

    
	
    
	
    

    <a class="addthis_counter addthis_pill_style"></a>
	
  </div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>
 		        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'd7beb7890a79c73a3e3d',
        clientSecret: '80ea1fc195ae4b80cbd65ec9f1ce68d59595af4b',
        id: md5(window.location.pathname),
        repo: 'shanhm1991.github.io',
        owner: 'shanhm1991',
        admin: 'shanhm1991'
    })
    gitalk.render('gitalk-container')
</script>                              



</div></div>
    <aside id="sidebar" class="alignright">
  


  

  

  

  
<div class="widget catlog">
<h3 class="title">Catlog</h3>
<ul class="entry_catlog">
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引言"><span class="toc-text">引言</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-解析"><span class="toc-text">1.4. 解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-初始化"><span class="toc-text">1.5. 初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-类加载器"><span class="toc-text">2. 类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-双亲委派模式"><span class="toc-text">2.1. 双亲委派模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-ClassLoader"><span class="toc-text">2.2. ClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-Launcher"><span class="toc-text">2.3. Launcher</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-ExtClassLoader"><span class="toc-text">2.3.1. ExtClassLoader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-AppClassLoader"><span class="toc-text">2.3.2. AppClassLoader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-ContextClassLoader"><span class="toc-text">2.3.3. ContextClassLoader</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-示例"><span class="toc-text">3. 示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-DriverManager"><span class="toc-text">3.1. DriverManager</span></a></li></ol></li></ol></li></ol>
</div>




</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">

  
  
      &copy; 2021 shanhm1991 
  
  
  
  <font style="float: right">
</div>
<div class="clearfix"></div>
</footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
