<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>借助ThreadPool实现定时任务. 一. 详细设计 | Essay</title>
  <meta name="author" content="shanhm1991">
  
  <meta name="description" content="引言写这个工具最开始是为了处理各种离线数据文件的需求，涉及到定时处理或者批处理等等，当时也是因为条件有限所以就自己造了这样一个轮子，也由于是为了文件处理，所以就取名为fom。fom中以Context为模块单位，其在内部维护了一个线程池和一个自定义的轮询线程来控制任务的执行计划，并自定义了一套状态转换机制。对于具体的任务则抽象为Task，其相当于在Callable的基础上定义了一个执行的方法模板，
并加了一些限制，比如强制要求任务id。至于其它操作和功能都是在Context和Task这两个基础上进行，本质上还是围绕着线程池在实现。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="借助ThreadPool实现定时任务. 一. 详细设计"/>
  <meta property="og:site_name" content="Essay"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Essay" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-147251181-1', 'auto');
	ga('send', 'pageview');

</script>


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header id="header" class="inner"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="alignleft">
  <h1><a href="/">Essay</a></h1>
  <h2><font style="color: #999;">articles:  61 &nbsp;&nbsp;&nbsp; views: <span id="busuanzi_value_site_uv"></span></font></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/about">Abount</a></li>
    
      <li><a href="/books">Books</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>

<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-20190702" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2019-07-01T16:00:00.000Z"><a href="/2019/07/02/20190702/">2019-07-02</a></time>
      
      

  
  
    <h1 class="p-name title" itemprop="headline name">
        借助ThreadPool实现定时任务. 一. 详细设计
    </h1>
    
    
  
  
  


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


   <font style="color: #999;"> words: 4k  &nbsp;&nbsp; views: <span id="busuanzi_value_page_pv"></span> &nbsp;&nbsp; time: 17min</font>
   
   
  
  <div class="categories">
    <a href="/categories/代码笔记/">代码笔记</a>
  </div>


   
   
  
  <div class="tags">
    <a href="/tags/fom/">fom</a>
  </div>


   
   <hr style="background-color: #ddd; height:1px; border:none;" /><br>
   


    </header>
      
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>写这个工具最开始是为了处理各种离线数据文件的需求，涉及到定时处理或者批处理等等，当时也是因为条件有限所以就自己造了这样一个轮子，也由于是为了文件处理，所以就取名为fom。<br>fom中以Context为模块单位，其在内部维护了一个线程池和一个自定义的轮询线程来控制任务的执行计划，并自定义了一套状态转换机制。对于具体的任务则抽象为Task，其相当于在Callable的基础上定义了一个执行的方法模板，
并加了一些限制，比如强制要求任务id。至于其它操作和功能都是在Context和Task这两个基础上进行，本质上还是围绕着线程池在实现。</p>
<a id="more"></a>

<h3 id="1-功能实现"><a href="#1-功能实现" class="headerlink" title="1. 功能实现"></a>1. 功能实现</h3><ol>
<li>支持三种定时语义(类似spring schedule)，cron：按时间计划表执行；fixedRate：任务开始后等待指定时间执行；fixedDelay：任务结束后等待指定时间执行；</li>
<li>支持动态关闭(shutDown)或启动(startup)定时任务，不需要重启服务，并可以自定义关闭时的事件处理onScheduleTerminate；</li>
<li>支持手动执行任务，即如果还没到设置的执行时间，可以手动使其立即执行(execNow)；</li>
<li>支持任务超时检测，即当任务执行超过设置时间后，可以及时主动中断任务</li>
<li>支持任务冲突检测，限制每个任务都必须有一个全局唯一的id，如果id已存在对应的任务并且还未结束，则id对应的当前任务会被忽略；</li>
<li>支持实时修改定时计划等配置，以及其它自定义配置；</li>
<li>支持持久化，即配置修改完之后如果重启，修改依然生效；</li>
<li>支持批任务，即可以定时执行一批任务集合，并且可以定义批任务全部执行完成时的事件处理onScheduleComplete（当然上面单个任务同样也可以），在事件中可以拿到当前批任务结果。</li>
<li>支持一些的简单的界面运维，比如查看任务统计或者正在执行的任务堆栈，下载已经完成任务结果数据，实时修改配置等等</li>
<li>支持xml配置或者注解的使用方式，简单易用；</li>
</ol>
<h3 id="2-实现思路"><a href="#2-实现思路" class="headerlink" title="2. 实现思路"></a>2. 实现思路</h3><p>下图整体描述Context中的实现流程：</p>
<p><img src="/img/20190702/20190702.2.jpg" alt=""></p>
<p>可以看出，在初始化之后，整个流程运行起来其实是一个无限循环，其出口有下面几种情况：</p>
<ol>
<li>如果检测到状态为STOPPING（被shutDown），那么将立即关闭线程池<code>pool.shutdownNow()</code>，然后一直等待线程池关闭，并且忽略任何中断请求；</li>
<li>如果execOnLoad=true（加载时执行），并且nextTime计算为0（没有配置任何定时计划），那么将在初始化后执行一次然后自行关闭<code>pool.shutdown()</code>（如果执行过程中没有被shutDown，那么在等待线程池关闭时将直接通过，因为任务实际已经结束）；</li>
<li>如果execOnLoad=false，并且也没有配置任何定时计划，那么直接退出，同时保留初始化后的线程池，此时可以将其当成一个线程池来使用，手动提交任务；</li>
</ol>
<p>下面对照图中的流程对一些主要的实现再做一些说明    </p>
<h4 id="2-1-onScheduleComplete"><a href="#2-1-onScheduleComplete" class="headerlink" title="2.1 onScheduleComplete"></a>2.1 onScheduleComplete</h4><p>onScheduleComplete语义很简单，就是等所有任务提交完并且所有提交的任务都完成时便执行，主要借助以下三个变量来实现：</p>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleBatch</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line marked">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> hasSubmitCompleted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line marked">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger taskNotCompleted = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line marked">    <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch completeLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ...		</span></span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        hasSubmitCompleted = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasSubmitCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hasSubmitCompleted;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">taskCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        completeLatch.countDown();</span><br><span class="line">    &#125; </span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">waitTaskCompleted</span><span class="params">(<span class="keyword">long</span> taskOverTime)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> completeLatch.await(taskOverTime, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">increaseTaskNotCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> taskNotCompleted.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTaskCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> taskNotCompleted.decrementAndGet() == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ...	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路是，<font color="#9E0152">提交线程中每提交一个任务就将taskNotCompleted加1，而任务线程中在完成时将taskNotCompleted减1，这样当taskNotCompleted计数为0时则说明代表提交的任务都已经完成。但是考虑到提交任务本身有一定的操作，
如果任务本身执行又非常快，那么可能在提交第二个任务时，第一个任务线程已经完成而检测到taskNotCompleted为0，并提前执行onScheduleComplete，因此再加一个hasSubmitCompleted条件，确保onScheduleComplete在任务全部提交完成之后触发。</font></p>
<p>在下面实现中，提交线程提交完任务或者任务线程执行完成时都会检测<code>checkScheduleComplete</code>，如果结果为真就放开<code>completeLatch</code>，这样定时线程便可以通过<code>waitTaskCompleted</code>。</p>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runSchedul</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line"></span><br><span class="line">    switchState(RUNNING);</span><br><span class="line"></span><br><span class="line">    schedulTimes++;</span><br><span class="line"></span><br><span class="line">    lastTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    ScheduleBatch&lt;E&gt; schedulebatch = <span class="keyword">new</span> ScheduleBatch&lt;&gt;(<span class="keyword">true</span>, schedulTimes, lastTime);</span><br><span class="line">    Task&lt;E&gt; task = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Collection&lt;? extends Task&lt;E&gt;&gt; tasks = newSchedulTasks();</span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(tasks))&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SUBMITMAP)&#123;</span><br><span class="line">                <span class="keyword">for</span> (Task&lt;E&gt; t : tasks) &#123;</span><br><span class="line">                    task = t;</span><br><span class="line">                    task.scheduleBatch = schedulebatch;</span><br><span class="line">                    String taskId = task.getId();</span><br><span class="line">                    <span class="keyword">if</span> (isTaskAlive(taskId)) &#123;</span><br><span class="line">                        log.warn(<span class="string">"task[&#123;&#125;] is still alive, create canceled."</span>, taskId);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    TimedFuture future = submit(task);</span><br><span class="line">                    SUBMITMAP.put(taskId, future);    </span><br><span class="line">                    submitFutures.add(future);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">        Assert.notNull(task, <span class="string">""</span>);</span><br><span class="line">        log.warn(<span class="string">"task["</span> + task.getId() + <span class="string">"] submit rejected."</span>, e);</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123; </span><br><span class="line marked">        schedulebatch.submitCompleted();</span><br><span class="line marked">        checkScheduleComplete(schedulebatch);</span><br><span class="line marked">        caculateNextTime(schedulebatch); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> TimedFuture&lt;Result&lt;E&gt;&gt; submit(Task&lt;E&gt; task) &#123;</span><br><span class="line">    <span class="keyword">if</span>(SUBMITS.incrementAndGet() % SECOND_UNIT == <span class="number">0</span>)&#123;</span><br><span class="line">        Monitor.jvm();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String taskId = task.getId();</span><br><span class="line">    task.setContext(Context.<span class="keyword">this</span>); </span><br><span class="line"></span><br><span class="line">    TimedFuture&lt;Result&lt;E&gt;&gt; future = config.pool.submit(task);</span><br><span class="line">    <span class="keyword">if</span>(task.scheduleBatch != <span class="keyword">null</span>)&#123;</span><br><span class="line marked">        task.scheduleBatch.increaseTaskNotCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"task[&#123;&#125;] submitted."</span>, taskId); </span><br><span class="line">    <span class="keyword">return</span> future; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkScheduleComplete</span><span class="params">(ScheduleBatch&lt;E&gt; scheduleBatch)</span></span>&#123;</span><br><span class="line">    String s = scheduleBatch.isSchedul ? <span class="string">"schedul"</span> : <span class="string">"submit"</span>;</span><br><span class="line marked">    <span class="keyword">boolean</span> isLastTaskComplete = scheduleBatch.hasTaskCompleted();</span><br><span class="line marked">    <span class="keyword">boolean</span> hasSubmitCompleted = scheduleBatch.hasSubmitCompleted();</span><br><span class="line">    <span class="keyword">if</span>(log.isDebugEnabled())&#123;</span><br><span class="line">        log.debug(s + <span class="string">"["</span> + scheduleBatch.getSchedulTimes() + <span class="string">"], isSubmitFinished："</span> </span><br><span class="line">            + hasSubmitCompleted + <span class="string">", taskNotCompleted："</span> + scheduleBatch.getTaskNotCompleted()); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line marked">    <span class="keyword">if</span>(isLastTaskComplete &amp;&amp; hasSubmitCompleted)&#123; </span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled())&#123;</span><br><span class="line">            String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd HH:mm:ss"</span>).format(scheduleBatch.getSchedulTime());</span><br><span class="line">            log.debug(scheduleBatch.getList().size() +  <span class="string">" tasks of "</span> + s </span><br><span class="line">                + <span class="string">"["</span> + scheduleBatch.getSchedulTimes() + <span class="string">"] submitted on "</span> + time  + <span class="string">" completed."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            onScheduleComplete(scheduleBatch.getSchedulTimes(), scheduleBatch.getSchedulTime(), scheduleBatch.getList());</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            log.error(<span class="string">""</span>, e); </span><br><span class="line">        &#125;</span><br><span class="line marked">        scheduleBatch.taskCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">caculateNextTime</span><span class="params">(ScheduleBatch&lt;E&gt; scheduleBatch)</span> </span>&#123; </span><br><span class="line">    Date last = <span class="keyword">new</span> Date();</span><br><span class="line">    <span class="keyword">if</span>(lastTime &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        last = <span class="keyword">new</span> Date(lastTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(config.cronExpression != <span class="keyword">null</span>)&#123;</span><br><span class="line">        nextTime = config.cronExpression.getTimeAfter(last).getTime();</span><br><span class="line">        waitTaskCompleted(scheduleBatch);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(config.getFixedRate() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        nextTime = last.getTime() + config.getFixedRate() * SECOND_UNIT;</span><br><span class="line">        waitTaskCompleted(scheduleBatch);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(config.getFixedDelay() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        waitTaskCompleted(scheduleBatch);</span><br><span class="line">        nextTime = System.currentTimeMillis() + config.getFixedDelay() * SECOND_UNIT;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        waitTaskCompleted(scheduleBatch);</span><br><span class="line">        nextTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitTaskCompleted</span><span class="params">(ScheduleBatch&lt;E&gt; scheduleBatch)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(scheduleBatch == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> overTime = config.getOverTime();</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line marked">            <span class="keyword">if</span>(scheduleBatch.waitTaskCompleted(overTime))&#123; </span><br><span class="line">                cleanCompletedFutures();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(config.getCancellable())&#123;</span><br><span class="line">                <span class="keyword">for</span>(TimedFuture&lt;Result&lt;E&gt;&gt; future : submitFutures)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(!future.isDone() &amp;&amp; !future.isCancelled())&#123;</span><br><span class="line">                        <span class="keyword">long</span> cost = System.currentTimeMillis() - future.getStartTime(); </span><br><span class="line">                        <span class="keyword">if</span>(cost &gt;= overTime * SECOND_UNIT)&#123;</span><br><span class="line">                            log.warn(<span class="string">"cancle task[&#123;&#125;] which has time out, cost=&#123;&#125;ms"</span>, future.getTaskId(), cost);</span><br><span class="line">                            future.cancel(<span class="keyword">true</span>);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="keyword">long</span> leftTime = overTime - cost / SECOND_UNIT;</span><br><span class="line">                            <span class="keyword">if</span>(leftTime &lt; overTime)&#123;</span><br><span class="line">                                overTime = leftTime;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        Thread.currentThread().interrupt(); <span class="comment">// 保留中断请求，留给后面wait检测处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-任务超时检测"><a href="#2-2-任务超时检测" class="headerlink" title="2.2. 任务超时检测"></a>2.2. 任务超时检测</h4><p>关于任务超时检测的实现就上面2.1中的<code>waitTaskCompleted(ScheduleBatch&lt;E&gt; scheduleBatch)</code>，其流程如下：</p>
<p><img src="/img/20190702/20190702.3.jpg" alt=""></p>
<p>可以看出，<font color="#9E0152">这里也是一个无线循环等待，直至completeLatch放开（所有任务结束）或者等待被中断才会退出，如果是被中断，那么在退出之前会保留中断标记，以便后面能够检测处理。</font><br>另外，对于循环等待的时间为设置的超时时间（有默认值），如果任务允许取消，那么每次等待之后便会检查所有提交的任务，对于已经超时的任务则尝试取消，对于没有超时的任务则获取一个最近要超时的任务的等待时间，以便能下一次能及时检测超时。</p>
<h4 id="2-3-execNow与shutDown"><a href="#2-3-execNow与shutDown" class="headerlink" title="2.3. execNow与shutDown"></a>2.3. execNow与shutDown</h4><p><font color="#9E0152">对于定时任务的状态，可以由外部其它线程来改变</font>，但是限制了状态转换规则如下：</p>
<p><img src="/img/20190702/20190702.1.jpg" alt=""></p>
<p>对于execNow，只有在定时任务状态为SLEEPING时才会处理，此时定时线程处于阻塞状态，等待下次执行时间，实现很简单，直接中断定时线程即可；<br>对于shutDown，定时任务的状态可能为SLEEPING或者RUNNING，其处理是将状态切换为STOPPING，然后再中断定时线程。<br>如果状态为SLEEPING，则同样定时线程阻塞在<code>wait(waitTime)</code>，等待下次执行时间，收到中断后将立即退出等待，进而很快检测到状态为STOPPING，然后等待任务线程池关闭；如果状态为RUNNING，则首先会在2.2的等待中检测到中断，
其处理是保留中断并立即退出，接着将很快在<code>wait(waitTime)</code>之前再次检测到中断，然后同样很快检测到STOPPING而转入结束等待，即等待所有任务结束及线程池关闭；</p>
<p>关于等待线程池关闭的具体实现如下：</p>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">terminate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//switchState(WAITING);</span></span><br><span class="line">    config.pool.shutdown();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(waitTask())&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            onScheduleTerminate(schedulTimes, lastTime);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            log.error(<span class="string">""</span>, e); </span><br><span class="line">        &#125;</span><br><span class="line">        switchState(STOPPED);</span><br><span class="line">        isFirstRun = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cleanCompletedFutures();</span><br><span class="line">&#125;</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isStopping = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isStopping)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Context.<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(state == STOPPING)&#123;</span><br><span class="line">                    isStopping = <span class="keyword">true</span>;</span><br><span class="line">                    config.pool.shutdownNow();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(config.pool.awaitTermination(<span class="number">1</span>, TimeUnit.DAYS))&#123;</span><br><span class="line">                log.info(<span class="string">"context[&#123;&#125;] stoped."</span>, name);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(isStopping)&#123;</span><br><span class="line">                log.warn(<span class="string">"context[&#123;&#125;] is still stopping, though has waiting for a day."</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.warn(<span class="string">"interrupt ignore when waiting task completetion."</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-任务冲突检测"><a href="#2-4-任务冲突检测" class="headerlink" title="2.4. 任务冲突检测"></a>2.4. 任务冲突检测</h4><p>关于检测任务冲突的思路很简单，就是使用Map<id-future>来缓存提交的任务，如果提交时id已经存在并且没结束则忽略。但是<font color="#9E0152">对future的检测存在先获取再判断的线程安全问题，
所以只能对整个Map使用同步。而且，为了在2.1中<code>waitTaskCompleted</code>循环等待任务完成时不用参与Map的同步，每次提交的任务在<code>submitFutures</code>中也记录了一份，其在任务完成时进行清除，
但是清除时还是要检查下<code>SUBMITMAP</code>中对应future，因为可能当前提交的任务完成后，又有其它的Context用同样的taskId提交了任务并正在执行。</font></p>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有Context共用，以便根据id实现任务冲突检测</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String,TimedFuture&lt;Result&lt;?&gt;&gt;&gt; SUBMITMAP = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前Context当前提交的任务Future</span></span><br><span class="line"><span class="keyword">private</span> List&lt;TimedFuture&lt;Result&lt;E&gt;&gt;&gt; submitFutures = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskAlive</span><span class="params">(String taskId)</span></span>&#123;</span><br><span class="line">    Future&lt;Result&lt;?&gt;&gt; future = SUBMITMAP.get(taskId);</span><br><span class="line">    <span class="keyword">return</span> future != <span class="keyword">null</span> &amp;&amp; !future.isDone();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanCompletedFutures</span><span class="params">()</span></span>&#123; </span><br><span class="line">    <span class="keyword">synchronized</span> (SUBMITMAP) &#123;</span><br><span class="line marked">        <span class="keyword">for</span>(TimedFuture&lt;Result&lt;E&gt;&gt; currentFuture : submitFutures)&#123;</span><br><span class="line marked">            String taskId = currentFuture.getTaskId();</span><br><span class="line marked">            TimedFuture&lt;Result&lt;?&gt;&gt; otherFuture = SUBMITMAP.get(taskId);</span><br><span class="line marked">            <span class="keyword">if</span>(otherFuture.isDone())&#123; </span><br><span class="line marked">                SUBMITMAP.remove(taskId);</span><br><span class="line marked">            &#125;</span><br><span class="line marked">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    submitFutures.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外要注意的是，<font color="#9E0152">对于外部线程主动提交（即调用<code>submit</code>或<code>submitBatch</code>）的任务将不支持冲突检测，因为对于主动提交的future没有合适的检查清除时机，而如果不清除将会造成内存泄漏。</font>
不过对于<code>submitBatch</code>，同样实现了onScheduleComplete，因此可以将其当成CompletionService使用。</p>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitBatch</span><span class="params">(Collection&lt;? extends Task&lt;E&gt;&gt; tasks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(CollectionUtils.isEmpty(tasks))&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;? extends Task&lt;E&gt;&gt; it = tasks.iterator();</span><br><span class="line">    ScheduleBatch&lt;E&gt; scheduleBatch = <span class="keyword">new</span> ScheduleBatch&lt;&gt;(<span class="keyword">false</span>, batchSubmits.incrementAndGet(), System.currentTimeMillis());</span><br><span class="line">    Task&lt;E&gt; task = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">            task = it.next();</span><br><span class="line">            task.scheduleBatch = scheduleBatch;</span><br><span class="line">            submit(task);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">        Assert.notNull(task, <span class="string">""</span>);</span><br><span class="line">        log.warn(<span class="string">"task["</span> + task.getId() + <span class="string">"] submit rejected."</span>, e);</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123; </span><br><span class="line">        scheduleBatch.submitCompleted();</span><br><span class="line">        checkScheduleComplete(scheduleBatch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> TimedFuture&lt;Result&lt;E&gt;&gt; submit(Task&lt;E&gt; task) &#123;</span><br><span class="line">    <span class="keyword">if</span>(SUBMITS.incrementAndGet() % SECOND_UNIT == <span class="number">0</span>)&#123;</span><br><span class="line">        Monitor.jvm();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String taskId = task.getId();</span><br><span class="line">    task.setContext(Context.<span class="keyword">this</span>); </span><br><span class="line"></span><br><span class="line">    TimedFuture&lt;Result&lt;E&gt;&gt; future = config.pool.submit(task);</span><br><span class="line">    <span class="keyword">if</span>(task.scheduleBatch != <span class="keyword">null</span>)&#123;</span><br><span class="line">        task.scheduleBatch.increaseTaskNotCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"task[&#123;&#125;] submitted."</span>, taskId); </span><br><span class="line">    <span class="keyword">return</span> future; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-加载策略"><a href="#3-加载策略" class="headerlink" title="3. 加载策略"></a>3. 加载策略</h3><p>对于Context的加载和管理，<font color="#9E0152">实现中要求每个Context必须有一个全局唯一的name，如果没有设置则默认对应Class的名称。对于每个name的Context，以第一次加载成功的为准，后面再出现则忽略。
因此这里涉及到一个加载优先级：缓存 &gt; xml配置 &gt; @FomContext &gt; @FomSchedul。</font>    </p>
<h4 id="3-1-加载缓存"><a href="#3-1-加载缓存" class="headerlink" title="3.1. 加载缓存"></a>3.1. 加载缓存</h4><p>如果运行过程中通过界面对Context的定时计划或者配置进行了修改，那么修改成功后将会以json的形式将其Class信息及修改后的配置持久化到默认的缓存目录，在下次启动时将优先加载这些缓存文件。</p>
<h4 id="3-2-加载xml"><a href="#3-2-加载xml" class="headerlink" title="3.2. 加载xml"></a>3.2. 加载xml</h4><p>默认从<code>classpath:/config/fom.xml</code>开始加载，如果是其它位置可以通过环境参数<code>-DfomConfigLocation=xx</code>指定，也可以在xml中包含：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;includes&gt;</span><br><span class="line">    &lt;include&gt;**&#x2F;fom*.xml&lt;&#x2F;include&gt;</span><br><span class="line">&lt;&#x2F;includes&gt;</span><br></pre></td></tr></table></figure>

<p>但是加载时要求对应的class必须是继承自Context的子类</p>
<h4 id="3-3-加载-FomContext"><a href="#3-3-加载-FomContext" class="headerlink" title="3.3. 加载@FomContext"></a>3.3. 加载@FomContext</h4><p>如果不想配置xml，可以通过@FomContext注解来标识，但是同样要求class必须是继承自Context的子类。对于注解扫描的package可以通过@FomScan来指定，或者在xml中指定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;fom-scan&gt;com.test.xx&lt;&#x2F;fom-scan&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-加载-FomSchedul"><a href="#3-4-加载-FomSchedul" class="headerlink" title="3.4. 加载@FomSchedul"></a>3.4. 加载@FomSchedul</h4><p>使用@FomSchedul将非常方便，不再要求继承Context，这是因为<font color="#9E0152">实现中已经将流程中的三个事件抽象成了接口，这样加载时就可以创建一个对应的实例，
并将其这些已知的方法放到一个新建的Context流程中执行，想执行哪个事件就实现对应的接口即可</font>     </p>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/</span><span class="caption">annotation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulFactory</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Collection&lt;? extends Task&lt;E&gt;&gt; newSchedulTasks() <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulCompleter</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * schedule任务完成时触发</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> schedulTimes schedul执行次数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> schedulTime schedul执行时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> results 任务执行的结果集</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScheduleComplete</span><span class="params">(<span class="keyword">long</span> schedulTimes, <span class="keyword">long</span> schedulTime, List&lt;Result&lt;E&gt;&gt; results)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulTerminator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * schedule终结时触发</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> schedulTimes 定时任务已经执行次数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lastTime 最后一次执行时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScheduleTerminate</span><span class="params">(<span class="keyword">long</span> schedulTimes, <span class="keyword">long</span> lastTime)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">ContextManager.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadFomSchedul</span><span class="params">(Class&lt;?&gt; clazz, ConcurrentHashMap&lt;String, String&gt; map, <span class="keyword">boolean</span> putConfig)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">    String cron = fc.cron();</span><br><span class="line">    <span class="keyword">long</span> fixedRate = fc.fixedRate();</span><br><span class="line">    <span class="keyword">long</span> fixedDelay = fc.fixedDelay();</span><br><span class="line"></span><br><span class="line">    List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Method method : clazz.getMethods())&#123;</span><br><span class="line">        Scheduled sch = method.getAnnotation(Scheduled<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span>(sch != <span class="keyword">null</span>)&#123;</span><br><span class="line">            methods.add(method);</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isBlank(cron))&#123;</span><br><span class="line">                cron = sch.cron();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(fixedRate &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                fixedRate = sch.fixedRate();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(fixedDelay &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                fixedDelay = sch.fixedDelay();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Object instance = clazz.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">    Context&lt;Object&gt; context = <span class="keyword">new</span> Context&lt;Object&gt;()&#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Collection&lt;Task&lt;Object&gt;&gt; newSchedulTasks() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            List&lt;Task&lt;Object&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="comment">// 创建所有Scheduled方法对应的任务，但是共用一个定时计划</span></span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(Method method : methods)&#123;</span><br><span class="line">                Task&lt;Object&gt; task = <span class="keyword">new</span> Task&lt;Object&gt;(name + <span class="string">"-task-"</span> + ++index)&#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">exec</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> method.invoke(instance);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;; </span><br><span class="line">                list.add(task);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果实现了SchedulFactory，将其创建的任务也算入</span></span><br><span class="line">            Collection&lt;? extends Task&lt;Object&gt;&gt; newTasks;</span><br><span class="line">            <span class="keyword">if</span>(SchedulFactory<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">                    &amp;&amp; (<span class="title">newTasks</span> </span>= ((SchedulFactory&lt;Object&gt;)instance).newSchedulTasks()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                list.addAll(newTasks);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScheduleComplete</span><span class="params">(<span class="keyword">long</span> batch, <span class="keyword">long</span> batchTime, List&lt;Result&lt;Object&gt;&gt; results)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(SchedulCompleter<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>))</span>&#123;</span><br><span class="line">                ((SchedulCompleter&lt;Object&gt;)instance).onScheduleComplete(batch, batchTime, results);  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScheduleTerminate</span><span class="params">(<span class="keyword">long</span> schedulTimes, <span class="keyword">long</span> lastTime)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(SchedulTerminator<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>))</span>&#123;</span><br><span class="line">                ((SchedulTerminator)instance).onScheduleTerminate(schedulTimes, lastTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的加载实现可以知道，使用@FomSchedul的类中，所有添加了@Scheduled的方法都会被创建成任务，如果实现了<code>SchedulFactory</code>，那么连同<code>newSchedulTasks</code>返回的任务一并算入定时批任务执行的集合，
其中对于定时计划则以第一个取到的为准，以@FomSchedul中配置的为最高优先级。</p>

      
    </div>
	
    <footer>
      
	  
	    
	<nav id="pagination">
	  
		  <a class="alignleft prev" href="/2019/07/04/20190704/">
		    借助ThreadPool实现定时任务. 二. 使用文档
		  </a>
	  
	  
	  
		  <a class="alignright next" href="/2019/06/30/20190630/">
		    借助poi解析Excel. 三. 定义解析规则配置
		  </a>
	  
	  <div class="clearfix"></div>
	</nav>
	
	    
        
  
  <div class="categories">
    <a href="/categories/代码笔记/">代码笔记</a>
  </div>


        
  
  <div class="tags">
    <a href="/tags/fom/">fom</a>
  </div>


        
  <div class="addthis addthis_toolbox addthis_default_style">
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'd7beb7890a79c73a3e3d',
        clientSecret: '80ea1fc195ae4b80cbd65ec9f1ce68d59595af4b',
        id: md5(window.location.pathname),
        repo: 'shanhm1991.github.io',
        owner: 'shanhm1991',
        admin: 'shanhm1991'
    })
    gitalk.render('gitalk-container')
</script>                              



</div></div>
    <aside id="sidebar" class="alignright">
  


  

  

  

  
<div class="widget catlog">
<h3 class="title">Catlog</h3>
<ul class="entry_catlog">
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引言"><span class="toc-text">引言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-功能实现"><span class="toc-text">1. 功能实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-实现思路"><span class="toc-text">2. 实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-onScheduleComplete"><span class="toc-text">2.1 onScheduleComplete</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-任务超时检测"><span class="toc-text">2.2. 任务超时检测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-execNow与shutDown"><span class="toc-text">2.3. execNow与shutDown</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-任务冲突检测"><span class="toc-text">2.4. 任务冲突检测</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-加载策略"><span class="toc-text">3. 加载策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-加载缓存"><span class="toc-text">3.1. 加载缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-加载xml"><span class="toc-text">3.2. 加载xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-加载-FomContext"><span class="toc-text">3.3. 加载@FomContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-加载-FomSchedul"><span class="toc-text">3.4. 加载@FomSchedul</span></a></li></ol></li></ol></li></ol>
</div>




</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">

  
  
      &copy; 2021 shanhm1991 
  
  
  
  <font style="float: right">
</div>
<div class="clearfix"></div>
</footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
