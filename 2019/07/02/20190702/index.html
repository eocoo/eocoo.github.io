<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>借助ThreadPool构建计划任务. 一. 设计文档 | Essay</title>
  <meta name="author" content="shanhm1991">
  
  <meta name="description" content="引言写这个工具最开始是为了处理各种离线数据文件的需求，涉及到定时处理或者批处理等等，当时也是因为条件有限所以就自己造了这样一个轮子，也由于是为了文件处理，所以就取名为fom。fom中以Context为模块单位，其在内部维护了一个线程池和一个自定义的轮询线程来控制任务的执行计划，并自定义了一套状态转换机制。对于具体的任务则抽象为Task，其相当于在Callable的基础上定义了一个执行的方法模板，
并加了一些限制，比如强制要求任务id。至于其它操作和功能都是在Context和Task这两个基础上进行，本质上还是围绕着线程池在实现。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="借助ThreadPool构建计划任务. 一. 设计文档"/>
  <meta property="og:site_name" content="Essay"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Essay" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-147251181-1', 'auto');
	ga('send', 'pageview');

</script>


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header id="header" class="inner"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="alignleft">
  <h1><a href="/">Essay</a></h1>
  <h2><font style="color: #999;">articles:  61 &nbsp;&nbsp;&nbsp; views: <span id="busuanzi_value_site_uv"></span></font></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/about">Abount</a></li>
    
      <li><a href="/books">Books</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>

<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-20190702" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2019-07-01T16:00:00.000Z"><a href="/2019/07/02/20190702/">2019-07-02</a></time>
      
      

  
  
    <h1 class="p-name title" itemprop="headline name">
        借助ThreadPool构建计划任务. 一. 设计文档
    </h1>
    
    
  
  
  


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


   <font style="color: #999;"> words: 5.1k  &nbsp;&nbsp; views: <span id="busuanzi_value_page_pv"></span> &nbsp;&nbsp; time: 21min</font>
   
   
  
  <div class="categories">
    <a href="/categories/代码笔记/">代码笔记</a>
  </div>


   
   
  
  <div class="tags">
    <a href="/tags/fom/">fom</a>
  </div>


   
   <hr style="background-color: #ddd; height:1px; border:none;" /><br>
   


    </header>
      
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>写这个工具最开始是为了处理各种离线数据文件的需求，涉及到定时处理或者批处理等等，当时也是因为条件有限所以就自己造了这样一个轮子，也由于是为了文件处理，所以就取名为fom。<br>fom中以Context为模块单位，其在内部维护了一个线程池和一个自定义的轮询线程来控制任务的执行计划，并自定义了一套状态转换机制。对于具体的任务则抽象为Task，其相当于在Callable的基础上定义了一个执行的方法模板，
并加了一些限制，比如强制要求任务id。至于其它操作和功能都是在Context和Task这两个基础上进行，本质上还是围绕着线程池在实现。</p>
<a id="more"></a>

<h3 id="1-功能设计"><a href="#1-功能设计" class="headerlink" title="1. 功能设计"></a>1. 功能设计</h3><ol>
<li>支持三种定时语义(类似spring schedule)，cron：按时间计划表执行；fixedRate：任务开始后等待指定时间执行；fixedDelay：任务结束后等待指定时间执行；</li>
<li>支持动态关闭(shutDown)和启动(startup)定时任务，不需要重启服务，并可以自定义关闭时的事件处理onScheduleTerminate；</li>
<li><font color="#9E0152">支持手动执行任务，即如果还没到设置的执行时间，可以手动使其立即执行(execNow)；</font></li>
<li><font color="#9E0152">支持任务超时检测，即当任务执行超过设置时间后，可以及时主动中断任务</font></li>
<li>支持任务冲突检测，限制每个任务都必须有一个全局唯一的id，如果id已存在对应的任务并且还未结束，则id对应的当前任务会被忽略；</li>
<li>支持实时修改定时计划等配置，以及其它自定义配置；</li>
<li>支持持久化，即配置修改完之后如果重启，修改依然生效；</li>
<li><font color="#9E0152">支持批任务，即可以定时执行一批任务集合，并可以自定义批任务执行完成时的事件处理onScheduleComplete，在事件中可以拿到当前批任务结果。</font></li>
<li>支持一些的简单的界面运维，比如查看任务统计或者正在执行的任务堆栈，下载已经完成任务结果数据，实时修改配置等等</li>
<li>支持xml配置或者注解的使用方式，简单易用；</li>
</ol>
<h3 id="2-流程设计"><a href="#2-流程设计" class="headerlink" title="2. 流程设计"></a>2. 流程设计</h3><p>下图整体描述了Context中的实现流程，其实主要内容就是一个轮询线程，一个线程池，以及几个状态的切换</p>
<p><img src="/img/20190702/20190702.5.jpg" alt=""> </p>
<p>其中对于状态的变换可以由轮询线程或者外部其它线程来控制，不过实现中对状态转换机制做了如下限制</p>
<p><img src="/img/20190702/20190702.1.jpg" alt=""></p>
<ul>
<li>如果处于<code>INITED</code>或<code>STOPPED</code>状态 </li>
</ul>
<p>可以接收外部线程的startup，即由外部线程将状态切换为<code>RUNNING</code>状态，并启动轮询线程；</p>
<ul>
<li>如果处于<code>RUNNING</code>状态</li>
</ul>
<p>轮询线程在等待任务结束之后，会将状态切换为<code>SLEEPING</code>，当然如果没有定时计划(认为是一次性任务)，那么会切换为<code>STOPPED</code>；</p>
<p>另外，处于<code>RUNNING</code>状态时可以接收外部的shutDown，即外部线程将状态切换为<code>STOPPING</code>，并请求中断轮询线程，那么轮询线程会直接跳过等待任务结束，然后很快检测到状态为<code>STOPPING</code>，接着等待线程池关闭后将状态切换为<code>STOPPED</code>；</p>
<ul>
<li>如果处于<code>SLEEPING</code>状态</li>
</ul>
<p>轮询线程在等到下次执行时间时，会将状态切换为<code>RUNNING</code>，然后再次创建任务并提交执行；</p>
<p>另外，处于<code>SLEEPING</code>状态时可以接收外部的execNow或shutDown，如果是shutDown，则先将状态切换为<code>STOPPING</code>，然后中断；如果是execNow，则直接中断；总之都会使轮询线程跳出等待，区别在于下次执行时是否会检测到状态为<code>STOPPING</code>;</p>
<ul>
<li>如果处于<code>STOPPING</code>状态</li>
</ul>
<p>此时将忽略一切外部中断，直到轮询线程等待线程池关闭后将状态切换为<code>STOPPED</code></p>
<h3 id="3-实现思路"><a href="#3-实现思路" class="headerlink" title="3. 实现思路"></a>3. 实现思路</h3><p>下面从代码实现的角度再具体描述下上面的流程，即从实现细节中梳理出一些主要的变量以及判断节点，整体如下</p>
<p><img src="/img/20190702/20190702.2.jpg" alt=""></p>
<p>其中，对于图中的<code>completeLatch.await(taskOverTime)</code>可以细化如下</p>
<p><img src="/img/20190702/20190702.3.jpg" alt=""></p>
<p>从流程实现中可以看出，轮询线程有三种结束的场景：</p>
<ol>
<li>如果检测到状态为<code>STOPPING</code>（被shutDown），那么将立即关闭线程池<code>pool.shutdownNow()</code>，然后一直等待线程池关闭，最后将状态切换为<code>STOPPED</code>；</li>
<li>如果execOnLoad=true（execOnLoad：轮询线程启动时是否立即执行任务），并且nextTime计算为0（没有配置任何定时计划），那么轮询线程将在启动后执行一次任务后自行关闭
（这时任务实际上已经结束，等待线程池关闭将直接通过，除非在执行任务时收到外部shutDown，那么可能跳到<code>STOPPING</code>并等待结束）；</li>
<li>如果execOnLoad=false，并且也没有配置任何定时计划，那么轮询线程将直接退出，不执行任何任务，此时将保留为<code>INITED</code>状态，可以将其当成一个线程池来使用，即手动提交任务；</li>
</ol>
<p>下面具体说明下几个主要功能或流程节点的实现思路  </p>
<h4 id="3-1-onScheduleComplete"><a href="#3-1-onScheduleComplete" class="headerlink" title="3.1. onScheduleComplete"></a>3.1. onScheduleComplete</h4><p>onScheduleComplete语义很简单，就是等所有任务都提交并且完成时便触发。实现思路即在上面的流程中，通过三个变量来控制:</p>
<ul>
<li><code>taskNotCompleted</code>：已经提交，但还没有完成的任务数；</li>
<li><code>hasSubmitCompleted</code>：任务是否已经全部提交完成；</li>
<li><code>completeLatch</code>：可以理解成控制轮询线程等待的栅栏</li>
</ul>
<p>思路是，轮询线程每提交一个任务将<code>taskNotCompleted</code>加1，而每次任务线程完成时将<code>taskNotCompleted</code>减1，那么当<code>taskNotCompleted</code>计数为0时便可以说明提交的任务都已经完成。<br>但是<font color="#9E0152">考虑到任务提交操作本身有一定的过程，这样如果任务本身执行又非常快，那么可能在提交第二个任务时，第一个任务线程已经完成并且检测到<code>taskNotCompleted</code>为0，
并提前触发<code>onScheduleComplete</code>，因此需要再加上<code>hasSubmitCompleted</code>，来确保<code>onScheduleComplete</code>一定在任务全部提交之后才触发。</font><br>至于<code>completeLatch</code>是用来阻塞轮询线程的，直到<code>onScheduleComplete</code>被触发之后才会放开，而执行<code>onScheduleComplete</code>的将是最后一个完成的任务线程（当然也有可能是轮询线程，
比如当轮询线程提交完任务后立即检测到<code>taskNotCompleted</code>为0，即提交的任务瞬间完成，任务线程完成时，轮询线程还没走到检测<code>taskNotCompleted</code>的步骤）。</p>
<p>这里可以举个场景例子：<font color="#9E0152">比如食堂师傅（轮询线程）与吃饭的员工（任务线程），每天在固定的饭点，师傅会给各个员工打饭，并要求最后一个吃完的员工把碗洗了（onScheduleComplete），
不过，假如最后一个员工吃完后，师傅还没把打饭的勺子放下，那就师傅自己洗。另外，师傅等到碗被洗完后会看下时间，并等到下次饭点再给大家打饭，而如果碗洗完后已经超过了下次饭点，则立即开始打饭。</font> </p>
<h4 id="3-2-任务超时检测"><a href="#3-2-任务超时检测" class="headerlink" title="3.2. 任务超时检测"></a>3.2. 任务超时检测</h4><p>即上面的<code>completeLatch.await(taskOverTime)</code>流程，即3.1中轮询线程提交完任务后，等待任务完成的过程中进行检测。</p>
<p>等待任务完成本身也是一个轮询，不过轮询的是<code>completeLatch.await(taskOverTime)</code>等待的结果，如果任务是可取消的（即cancellable为true），那么每次等完taskOverTime后，会检查下还没完成的任务，
对于执行时间已经超过taskOverTime的任务，则尝试取消；对于执行时间还没有达到taskOverTime的则取一个最近要超时的时间，并作为再次等待的时间，以便下次能及时检测到超时。</p>
<p>还是用上面的例子，<font color="#9E0152">师傅给每个员工打饭后会告诉他要在1小时内把饭吃完，等到全部员工打完饭之后，师傅会等一个小时来看下还有哪些员工没吃完，并且会询问这些员工吃了多久，如果吃了已经超过1小时，
则告诉他别再吃了，当然如果员工不理睬就继续吃下去（中断被忽略），对于还没吃到1小时的员工，就选一个最近要超时的，比如阿三吃了20分钟，阿四已经吃了50分钟，那师傅就再过10分钟后再来询问一遍。</font> </p>
<h4 id="3-3-execNow与shutDown"><a href="#3-3-execNow与shutDown" class="headerlink" title="3.3. execNow与shutDown"></a>3.3. execNow与shutDown</h4><p>就是立即执行与立即停止的意思，即对应上面图中的两个等待被中断的流程，其实在2中已经说得非常清楚了。</p>
<p>比如<font color="#9E0152">师傅在等待下次饭点打饭时，突然领导（外部线程）来了，说大家现在就要吃饭，那么师傅就直接开始给员工打饭。也可能领导跑过来说今天食堂关门了，不打饭了，那师傅就直接收拾下厨房（onScheduleTerminate）下班了。
如果领导来通知食堂关闭时大家还在吃饭，那师傅就通知下大家不要再吃了，并等待大家吃完，碗也洗完，最后收拾完厨房再下班</font> </p>
<h4 id="3-4-任务冲突检测"><a href="#3-4-任务冲突检测" class="headerlink" title="3.4. 任务冲突检测"></a>3.4. 任务冲突检测</h4><p>关于检测任务冲突的思路很简单，<code>SUBMITMAP</code>中保留了所有context提交的任务future，在提交时检查下要提交的任务id是否已经存在对应的任务，如果是则忽略。<br>要注意的是，<font color="#9E0152">对于外部线程主动提交（即调用<code>submit</code>或<code>submitBatch</code>）的任务将不支持冲突检测，因为对于主动提交的future没有合适的检查清除时机，而如果不清除将造成内存泄漏。</font></p>
<h3 id="4-代码实现"><a href="#4-代码实现" class="headerlink" title="4. 代码实现"></a>4. 代码实现</h3><p><code>ScheduleBatch</code>中封装了3.1中所说的三个变量，其作为轮询线程与任务线程的共享对象</p>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleBatch</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line marked">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> hasSubmitCompleted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line marked">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger taskNotCompleted = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line marked">    <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch completeLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ...		</span></span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        hasSubmitCompleted = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasSubmitCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hasSubmitCompleted;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">taskCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        completeLatch.countDown();</span><br><span class="line">    &#125; </span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">waitTaskCompleted</span><span class="params">(<span class="keyword">long</span> taskOverTime)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> completeLatch.await(taskOverTime, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">increaseTaskNotCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> taskNotCompleted.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTaskCompleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> taskNotCompleted.decrementAndGet() == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ...	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>runSchedul()</code>：轮询线程定时创建和提交任务，并记录下任务对应的future，作为后面实现冲突检测和超时检测的基础；</li>
<li><code>submit</code>：提交任务，提交成功后会将<code>taskNotCompleted</code>加1；</li>
<li><code>isTaskAlive</code>：是否已经存在taskId对应的任务，并且还没有结束；</li>
<li><code>checkScheduleComplete</code>：<font color="#9E0152">检查任务是否全部提交并执行完成，如果是则放开<code>completeLatch</code>，轮询线程提交完任务与任务线程完成时都检查执行这个方法；</font></li>
<li><code>caculateNextTime</code>：轮询线程计算下次执行时间，根据定时语义决定在计算前后等待已经提交的任务完成；</li>
<li><code>waitTaskCompleted</code>：<font color="#9E0152">循环等待提交的任务结束，直至completeLatch放开（所有任务结束）或者等待被中断才会退出，如果是被中断，那么在退出之前会保留中断请求，以便后面能够检测处理。另外，
对于循环等待的时间为设置的超时时间，如果任务允许取消，那么每次等待之后便会检查所有没完成的任务，对于已经超时的任务则尝试取消，对于没有超时的任务则获取一个最近要超时的任务的等待时间，以便能下一次能及时检测超时；</font></li>
<li><code>cleanCompletedFutures</code>：清理本次提交的任务id，<font color="#9E0152">对future的检测存在先获取再判断的线程安全问题，所以只能对整个Map使用同步。另外为了<code>waitTaskCompleted</code>中循环等待任务完成时不用参与Map的同步，
每次提交的任务在在<code>submitFutures</code>中也记录了一份，然后再完成时清除，但是清除时还是要检查下<code>SUBMITMAP</code>中对应future状态，因为可能当前提交的任务完成后，又有其它的Context用同样的taskId提交了任务并正在执行。</font></li>
</ul>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有Context共用，以便根据id实现任务冲突检测</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String,TimedFuture&lt;Result&lt;?&gt;&gt;&gt; SUBMITMAP = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前Context当前提交的任务Future</span></span><br><span class="line"><span class="keyword">private</span> List&lt;TimedFuture&lt;Result&lt;E&gt;&gt;&gt; submitFutures = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runSchedul</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line"></span><br><span class="line">    switchState(RUNNING);</span><br><span class="line"></span><br><span class="line">    schedulTimes++;</span><br><span class="line"></span><br><span class="line">    lastTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    ScheduleBatch&lt;E&gt; schedulebatch = <span class="keyword">new</span> ScheduleBatch&lt;&gt;(<span class="keyword">true</span>, schedulTimes, lastTime);</span><br><span class="line">    Task&lt;E&gt; task = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Collection&lt;? extends Task&lt;E&gt;&gt; tasks = newSchedulTasks();</span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(tasks))&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SUBMITMAP)&#123;</span><br><span class="line">                <span class="keyword">for</span> (Task&lt;E&gt; t : tasks) &#123;</span><br><span class="line">                    task = t;</span><br><span class="line">                    task.scheduleBatch = schedulebatch;</span><br><span class="line">                    String taskId = task.getId();</span><br><span class="line">                    <span class="keyword">if</span> (isTaskAlive(taskId)) &#123;</span><br><span class="line">                        log.warn(<span class="string">"task[&#123;&#125;] is still alive, create canceled."</span>, taskId);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line marked">                    TimedFuture future = submit(task);</span><br><span class="line marked">                    SUBMITMAP.put(taskId, future);    </span><br><span class="line marked">                    submitFutures.add(future);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">        Assert.notNull(task, <span class="string">""</span>);</span><br><span class="line">        log.warn(<span class="string">"task["</span> + task.getId() + <span class="string">"] submit rejected."</span>, e);</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123; </span><br><span class="line">        schedulebatch.submitCompleted();</span><br><span class="line">        checkScheduleComplete(schedulebatch);</span><br><span class="line">        caculateNextTime(schedulebatch); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskAlive</span><span class="params">(String taskId)</span></span>&#123;</span><br><span class="line">    Future&lt;Result&lt;?&gt;&gt; future = SUBMITMAP.get(taskId);</span><br><span class="line">    <span class="keyword">return</span> future != <span class="keyword">null</span> &amp;&amp; !future.isDone();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> TimedFuture&lt;Result&lt;E&gt;&gt; submit(Task&lt;E&gt; task) &#123;</span><br><span class="line">    <span class="keyword">if</span>(SUBMITS.incrementAndGet() % SECOND_UNIT == <span class="number">0</span>)&#123;</span><br><span class="line">        Monitor.jvm();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String taskId = task.getId();</span><br><span class="line">    task.setContext(Context.<span class="keyword">this</span>); </span><br><span class="line"></span><br><span class="line">    TimedFuture&lt;Result&lt;E&gt;&gt; future = config.pool.submit(task);</span><br><span class="line">    <span class="keyword">if</span>(task.scheduleBatch != <span class="keyword">null</span>)&#123;</span><br><span class="line marked">        task.scheduleBatch.increaseTaskNotCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"task[&#123;&#125;] submitted."</span>, taskId); </span><br><span class="line">    <span class="keyword">return</span> future; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkScheduleComplete</span><span class="params">(ScheduleBatch&lt;E&gt; scheduleBatch)</span></span>&#123;</span><br><span class="line">    String s = scheduleBatch.isSchedul ? <span class="string">"schedul"</span> : <span class="string">"submit"</span>;</span><br><span class="line marked">    <span class="keyword">boolean</span> isLastTaskComplete = scheduleBatch.hasTaskCompleted();</span><br><span class="line marked">    <span class="keyword">boolean</span> hasSubmitCompleted = scheduleBatch.hasSubmitCompleted();</span><br><span class="line">    <span class="keyword">if</span>(log.isDebugEnabled())&#123;</span><br><span class="line">        log.debug(s + <span class="string">"["</span> + scheduleBatch.getSchedulTimes() + <span class="string">"], isSubmitFinished："</span> </span><br><span class="line">            + hasSubmitCompleted + <span class="string">", taskNotCompleted："</span> + scheduleBatch.getTaskNotCompleted()); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line marked">    <span class="keyword">if</span>(isLastTaskComplete &amp;&amp; hasSubmitCompleted)&#123; </span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled())&#123;</span><br><span class="line">            String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd HH:mm:ss"</span>).format(scheduleBatch.getSchedulTime());</span><br><span class="line">            log.debug(scheduleBatch.getList().size() +  <span class="string">" tasks of "</span> + s </span><br><span class="line">                + <span class="string">"["</span> + scheduleBatch.getSchedulTimes() + <span class="string">"] submitted on "</span> + time  + <span class="string">" completed."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            onScheduleComplete(scheduleBatch.getSchedulTimes(), scheduleBatch.getSchedulTime(), scheduleBatch.getList());</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            log.error(<span class="string">""</span>, e); </span><br><span class="line">        &#125;</span><br><span class="line marked">        scheduleBatch.taskCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">caculateNextTime</span><span class="params">(ScheduleBatch&lt;E&gt; scheduleBatch)</span> </span>&#123; </span><br><span class="line">    Date last = <span class="keyword">new</span> Date();</span><br><span class="line">    <span class="keyword">if</span>(lastTime &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        last = <span class="keyword">new</span> Date(lastTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(config.cronExpression != <span class="keyword">null</span>)&#123;</span><br><span class="line">        nextTime = config.cronExpression.getTimeAfter(last).getTime();</span><br><span class="line">        waitTaskCompleted(scheduleBatch);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(config.getFixedRate() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        nextTime = last.getTime() + config.getFixedRate() * SECOND_UNIT;</span><br><span class="line">        waitTaskCompleted(scheduleBatch);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(config.getFixedDelay() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        waitTaskCompleted(scheduleBatch);</span><br><span class="line">        nextTime = System.currentTimeMillis() + config.getFixedDelay() * SECOND_UNIT;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        waitTaskCompleted(scheduleBatch);</span><br><span class="line">        nextTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitTaskCompleted</span><span class="params">(ScheduleBatch&lt;E&gt; scheduleBatch)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(scheduleBatch == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> overTime = config.getOverTime();</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line marked">            <span class="keyword">if</span>(scheduleBatch.waitTaskCompleted(overTime))&#123; </span><br><span class="line">                cleanCompletedFutures();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(config.getCancellable())&#123;</span><br><span class="line">                <span class="keyword">for</span>(TimedFuture&lt;Result&lt;E&gt;&gt; future : submitFutures)&#123;</span><br><span class="line marked">                    <span class="keyword">if</span>(!future.isDone() &amp;&amp; !future.isCancelled())&#123;</span><br><span class="line">                        <span class="keyword">long</span> cost = System.currentTimeMillis() - future.getStartTime(); </span><br><span class="line">                        <span class="keyword">if</span>(cost &gt;= overTime * SECOND_UNIT)&#123;</span><br><span class="line">                            log.warn(<span class="string">"cancle task[&#123;&#125;] which has time out, cost=&#123;&#125;ms"</span>, future.getTaskId(), cost);</span><br><span class="line marked">                            future.cancel(<span class="keyword">true</span>);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line marked">                            <span class="keyword">long</span> leftTime = overTime - cost / SECOND_UNIT;</span><br><span class="line marked">                            <span class="keyword">if</span>(leftTime &lt; overTime)&#123;</span><br><span class="line marked">                                overTime = leftTime;</span><br><span class="line marked">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        Thread.currentThread().interrupt(); <span class="comment">// 保留中断请求，留给后面wait检测处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanCompletedFutures</span><span class="params">()</span></span>&#123; </span><br><span class="line">    <span class="keyword">synchronized</span> (SUBMITMAP) &#123;</span><br><span class="line">        <span class="keyword">for</span>(TimedFuture&lt;Result&lt;E&gt;&gt; currentFuture : submitFutures)&#123;</span><br><span class="line">            String taskId = currentFuture.getTaskId();</span><br><span class="line">            TimedFuture&lt;Result&lt;?&gt;&gt; otherFuture = SUBMITMAP.get(taskId);</span><br><span class="line">            <span class="keyword">if</span>(otherFuture != <span class="keyword">null</span> &amp;&amp; otherFuture.isDone())&#123; </span><br><span class="line">                SUBMITMAP.remove(taskId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    submitFutures.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>terminate</code>：关闭线程池</li>
<li><code>waitTask</code>：等待线程池关闭</li>
</ul>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">terminate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//switchState(WAITING);</span></span><br><span class="line">    config.pool.shutdown();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(waitTask())&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            onScheduleTerminate(schedulTimes, lastTime);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            log.error(<span class="string">""</span>, e); </span><br><span class="line">        &#125;</span><br><span class="line">        switchState(STOPPED);</span><br><span class="line">        isFirstRun = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cleanCompletedFutures();</span><br><span class="line">&#125;</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isStopping = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isStopping)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Context.<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(state == STOPPING)&#123;</span><br><span class="line">                    isStopping = <span class="keyword">true</span>;</span><br><span class="line">                    config.pool.shutdownNow();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(config.pool.awaitTermination(<span class="number">1</span>, TimeUnit.DAYS))&#123;</span><br><span class="line">                log.info(<span class="string">"context[&#123;&#125;] stoped."</span>, name);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(isStopping)&#123;</span><br><span class="line">                log.warn(<span class="string">"context[&#123;&#125;] is still stopping, though has waiting for a day."</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.warn(<span class="string">"interrupt ignore when waiting task completetion."</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>submitBatch</code>：主动提交批任务，同时支持<code>onScheduleComplete</code> </li>
</ul>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">Context.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitBatch</span><span class="params">(Collection&lt;? extends Task&lt;E&gt;&gt; tasks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(CollectionUtils.isEmpty(tasks))&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;? extends Task&lt;E&gt;&gt; it = tasks.iterator();</span><br><span class="line">    ScheduleBatch&lt;E&gt; scheduleBatch = <span class="keyword">new</span> ScheduleBatch&lt;&gt;(<span class="keyword">false</span>, batchSubmits.incrementAndGet(), System.currentTimeMillis());</span><br><span class="line">    Task&lt;E&gt; task = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">            task = it.next();</span><br><span class="line">            task.scheduleBatch = scheduleBatch;</span><br><span class="line">            submit(task);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">        Assert.notNull(task, <span class="string">""</span>);</span><br><span class="line">        log.warn(<span class="string">"task["</span> + task.getId() + <span class="string">"] submit rejected."</span>, e);</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123; </span><br><span class="line">        scheduleBatch.submitCompleted();</span><br><span class="line">        checkScheduleComplete(scheduleBatch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-加载策略"><a href="#3-加载策略" class="headerlink" title="3. 加载策略"></a>3. 加载策略</h3><p>加载即将所有Context实例加载到内存并维护起来，基于此可以做一些维护操作，比如开放http接口提供一些简单的运维界面（<code>http://{ip}:{port}/fom.html</code>或<code>http://{ip}:{port}/{context-path}/task.html</code>），
至于<font color="#9E0152">加载的时机则在spring加载完之后，因此可以将其它的spring组件注入到自身当中，但是不能将自己注入到其它组件当中。</font></p>
<p>另外，在Context加载时<font color="#9E0152">要求每个Context必须有一个全局唯一的name，如果没有设置则默认对应Class的名称。对于每个name的Context，以第一次加载成功的为准，后面再出现则忽略，
因此还需要明确一个加载优先级。<br>即：缓存 &gt; xml配置 &gt; @FomContext &gt; @FomSchedul。</font>        </p>
<h4 id="3-1-加载缓存"><a href="#3-1-加载缓存" class="headerlink" title="3.1. 加载缓存"></a>3.1. 加载缓存</h4><p>如果运行过程中通过界面对Context的定时计划或者配置进行了修改，那么修改成功后将会以json的形式将其Class信息及修改后的配置持久化到默认的缓存目录，在下次启动时将优先加载这些缓存文件。</p>
<h4 id="3-2-加载xml"><a href="#3-2-加载xml" class="headerlink" title="3.2. 加载xml"></a>3.2. 加载xml</h4><p>默认从<code>classpath:/config/fom.xml</code>开始加载，如果是其它位置可以通过环境参数<code>-DfomConfigLocation=xx</code>指定，也可以在xml中包含：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;includes&gt;</span><br><span class="line">    &lt;include&gt;**&#x2F;fom*.xml&lt;&#x2F;include&gt;</span><br><span class="line">&lt;&#x2F;includes&gt;</span><br></pre></td></tr></table></figure>

<p>但是加载时要求对应的class必须是继承自Context的子类</p>
<h4 id="3-3-加载-FomContext"><a href="#3-3-加载-FomContext" class="headerlink" title="3.3. 加载@FomContext"></a>3.3. 加载@FomContext</h4><p>如果不想配置xml，可以通过@FomContext注解来标识，但是同样要求class必须是继承自Context的子类。对于注解扫描的package可以通过@FomScan来指定，或者在xml中指定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;fom-scan&gt;com.test.xx&lt;&#x2F;fom-scan&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-加载-FomSchedul"><a href="#3-4-加载-FomSchedul" class="headerlink" title="3.4. 加载@FomSchedul"></a>3.4. 加载@FomSchedul</h4><p>使用@FomSchedul将非常方便，不再要求继承Context，这是因为<font color="#9E0152">实现中已经将流程中的三个事件抽象成了接口，这样加载时就可以创建一个对应的实例，
并将其这些已知的方法放到一个新建的Context流程中执行，想执行哪个事件就实现对应的接口即可</font>     </p>
<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/</span><span class="caption">annotation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulFactory</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Collection&lt;? extends Task&lt;E&gt;&gt; newSchedulTasks() <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulCompleter</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * schedule任务完成时触发</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> schedulTimes schedul执行次数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> schedulTime schedul执行时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> results 任务执行的结果集</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScheduleComplete</span><span class="params">(<span class="keyword">long</span> schedulTimes, <span class="keyword">long</span> schedulTime, List&lt;Result&lt;E&gt;&gt; results)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulTerminator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * schedule终结时触发</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> schedulTimes 定时任务已经执行次数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lastTime 最后一次执行时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScheduleTerminate</span><span class="params">(<span class="keyword">long</span> schedulTimes, <span class="keyword">long</span> lastTime)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span class="fileDir">https://github.com/shanhm1991/fom/blob/master/fom-context/src/main/java/org/eto/fom/context/core/</span><span class="caption">ContextManager.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadFomSchedul</span><span class="params">(Class&lt;?&gt; clazz, ConcurrentHashMap&lt;String, String&gt; map, <span class="keyword">boolean</span> putConfig)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">    String cron = fc.cron();</span><br><span class="line">    <span class="keyword">long</span> fixedRate = fc.fixedRate();</span><br><span class="line">    <span class="keyword">long</span> fixedDelay = fc.fixedDelay();</span><br><span class="line"></span><br><span class="line">    List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Method method : clazz.getMethods())&#123;</span><br><span class="line">        Scheduled sch = method.getAnnotation(Scheduled<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span>(sch != <span class="keyword">null</span>)&#123;</span><br><span class="line">            methods.add(method);</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isBlank(cron))&#123;</span><br><span class="line">                cron = sch.cron();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(fixedRate &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                fixedRate = sch.fixedRate();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(fixedDelay &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                fixedDelay = sch.fixedDelay();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Object instance = clazz.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">    Context&lt;Object&gt; context = <span class="keyword">new</span> Context&lt;Object&gt;()&#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Collection&lt;Task&lt;Object&gt;&gt; newSchedulTasks() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            List&lt;Task&lt;Object&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="comment">// 创建所有Scheduled方法对应的任务，但是共用一个定时计划</span></span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(Method method : methods)&#123;</span><br><span class="line">                Task&lt;Object&gt; task = <span class="keyword">new</span> Task&lt;Object&gt;(name + <span class="string">"-task-"</span> + ++index)&#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">exec</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> method.invoke(instance);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;; </span><br><span class="line">                list.add(task);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果实现了SchedulFactory，将其创建的任务也算入</span></span><br><span class="line">            Collection&lt;? extends Task&lt;Object&gt;&gt; newTasks;</span><br><span class="line">            <span class="keyword">if</span>(SchedulFactory<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">                    &amp;&amp; (<span class="title">newTasks</span> </span>= ((SchedulFactory&lt;Object&gt;)instance).newSchedulTasks()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                list.addAll(newTasks);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScheduleComplete</span><span class="params">(<span class="keyword">long</span> batch, <span class="keyword">long</span> batchTime, List&lt;Result&lt;Object&gt;&gt; results)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(SchedulCompleter<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>))</span>&#123;</span><br><span class="line">                ((SchedulCompleter&lt;Object&gt;)instance).onScheduleComplete(batch, batchTime, results);  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScheduleTerminate</span><span class="params">(<span class="keyword">long</span> schedulTimes, <span class="keyword">long</span> lastTime)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(SchedulTerminator<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>))</span>&#123;</span><br><span class="line">                ((SchedulTerminator)instance).onScheduleTerminate(schedulTimes, lastTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的加载实现可以知道，<font color="#9E0152">使用@FomSchedul的类中，所有添加了@Scheduled的方法都会被创建成任务，如果实现了<code>SchedulFactory</code>，那么连同<code>newSchedulTasks</code>返回的任务一并算入定时批任务执行的集合，
其中对于定时计划则以第一个取到的为准，以@FomSchedul中配置的为最高优先级。</font></p>

      
    </div>
	
    <footer>
      
	  
	    
	<nav id="pagination">
	  
		  <a class="alignleft prev" href="/2019/07/04/20190704/">
		    借助ThreadPool构建计划任务. 二. 使用文档
		  </a>
	  
	  
	  
		  <a class="alignright next" href="/2019/06/30/20190630/">
		    借助poi解析Excel. 三. 定义解析规则配置
		  </a>
	  
	  <div class="clearfix"></div>
	</nav>
	
	    
        
  
  <div class="categories">
    <a href="/categories/代码笔记/">代码笔记</a>
  </div>


        
  
  <div class="tags">
    <a href="/tags/fom/">fom</a>
  </div>


        
  <div class="addthis addthis_toolbox addthis_default_style">
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'd7beb7890a79c73a3e3d',
        clientSecret: '80ea1fc195ae4b80cbd65ec9f1ce68d59595af4b',
        id: md5(window.location.pathname),
        repo: 'shanhm1991.github.io',
        owner: 'shanhm1991',
        admin: 'shanhm1991'
    })
    gitalk.render('gitalk-container')
</script>                              



</div></div>
    <aside id="sidebar" class="alignright">
  


  

  

  

  
<div class="widget catlog">
<h3 class="title">Catlog</h3>
<ul class="entry_catlog">
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引言"><span class="toc-text">引言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-功能设计"><span class="toc-text">1. 功能设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-流程设计"><span class="toc-text">2. 流程设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-实现思路"><span class="toc-text">3. 实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-onScheduleComplete"><span class="toc-text">3.1. onScheduleComplete</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-任务超时检测"><span class="toc-text">3.2. 任务超时检测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-execNow与shutDown"><span class="toc-text">3.3. execNow与shutDown</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-任务冲突检测"><span class="toc-text">3.4. 任务冲突检测</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-代码实现"><span class="toc-text">4. 代码实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-加载策略"><span class="toc-text">3. 加载策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-加载缓存"><span class="toc-text">3.1. 加载缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-加载xml"><span class="toc-text">3.2. 加载xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-加载-FomContext"><span class="toc-text">3.3. 加载@FomContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-加载-FomSchedul"><span class="toc-text">3.4. 加载@FomSchedul</span></a></li></ol></li></ol></li></ol>
</div>




</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">

  
  
      &copy; 2021 shanhm1991 
  
  
  
  <font style="float: right">
</div>
<div class="clearfix"></div>
</footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
